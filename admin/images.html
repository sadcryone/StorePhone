<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"/>
  <link rel="stylesheet" href="./assets/css/admin.css">
  <title>Qu·∫£n l√Ω ·∫£nh - Store Phone</title>
  <style>
    /* CSS cho trang qu·∫£n l√Ω ·∫£nh */
    .admin-content {
      padding: 20px;
    }
    
    .image-upload-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .upload-area {
      border: 2px dashed #cbd5e1;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      margin: 20px 0;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .upload-area:hover {
      border-color: #3b82f6;
      background: #f8fafc;
    }
    
    .upload-area.dragover {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .upload-icon {
      font-size: 48px;
      color: #94a3b8;
      margin-bottom: 15px;
    }
    
    .upload-hint {
      color: #64748b;
      font-size: 1.4rem;
      margin: 10px 0;
    }
    
    .file-input {
      display: none;
    }
    
    .upload-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.5rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 15px;
      position: relative;
      z-index: 2;
    }
    
    .upload-btn:hover {
      background: #2563eb;
    }
    
    .url-import {
      margin-top: 25px;
      padding-top: 25px;
      border-top: 1px solid #e2e8f0;
    }
    
    .url-input-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .url-input {
      flex: 1;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 1.4rem;
    }
    
    .import-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.4rem;
      white-space: nowrap;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .import-btn:hover {
      background: #059669;
    }
    
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .image-card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      background: white;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .image-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .image-preview {
      width: 100%;
      height: 150px;
      object-fit: contain;
      background: #f8fafc;
    }
    
    .image-info {
      padding: 15px;
    }
    
    .image-url {
      font-size: 1.2rem;
      color: #64748b;
      word-break: break-all;
      margin: 10px 0;
      padding: 8px;
      background: #f1f5f9;
      border-radius: 6px;
      max-height: 60px;
      overflow-y: auto;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .image-url:hover {
      background: #e2e8f0;
    }
    
    .image-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .copy-btn, .delete-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .copy-btn {
      background: #3b82f6;
      color: white;
    }
    
    .copy-btn:hover {
      background: #2563eb;
    }
    
    .delete-btn {
      background: #ef4444;
      color: white;
    }
    
    .delete-btn:hover {
      background: #dc2626;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      margin-top: 15px;
      overflow: hidden;
      display: none;
    }
    
    .progress-fill {
      height: 100%;
      background: #10b981;
      width: 0%;
      transition: width 0.3s;
    }
    
    .status-message {
      margin-top: 10px;
      font-size: 1.4rem;
      min-height: 24px;
    }
    
    .success {
      color: #10b981;
    }
    
    .error {
      color: #ef4444;
    }
    
    .settings-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .api-key-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 1.4rem;
      margin-top: 10px;
      font-family: monospace;
    }
    
    .save-btn {
      display: flex;
      justify-content: center;
      align-items: center;
      background: #8b5cf6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 15px;
      font-size: 1.4rem;
    }
    
    .save-btn:hover {
      background: #7c3aed;
    }

    .bulk-import-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .bulk-textarea {
      width: 100%;
      height: 120px;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 1.4rem;
      margin-top: 10px;
      font-family: monospace;
    }

    /* B·ªô l·ªçc ƒë∆°n gi·∫£n */
    .filter-section {
      background: white;
      border-radius: 12px;
      padding: 15px 20px;
      margin: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .filter-left {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-size: 1.4rem;
      color: #334155;
      white-space: nowrap;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 1.4rem;
      background: white;
      min-width: 150px;
    }

    .date-input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-input {
      padding: 8px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 1.4rem;
      width: 140px;
    }

    .filter-actions {
      display: flex;
      gap: 10px;
    }

    .btn-filter {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-filter:hover {
      background: #2563eb;
    }

    .btn-reset {
      background: #94a3b8;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-reset:hover {
      background: #64748b;
    }

    .image-stats {
      font-size: 1.3rem;
      color: #64748b;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- SIDEBAR -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <h2>STORE PHONE</h2>
        <p>Admin Dashboard</p>
      </div>
      
      <nav class="sidebar-menu">
        <a href="index.html" class="menu-item">
          <span class="material-symbols-outlined">inventory_2</span>
          S·∫£n ph·∫©m
        </a>
        <a href="orders.html" class="menu-item">
          <span class="material-symbols-outlined">shopping_bag</span>
          ƒê∆°n h√†ng
        </a>
        <a href="chats.html" class="menu-item">
          <span class="material-symbols-outlined">chat</span>
          Qu·∫£n l√Ω Chat
        </a>
        <a href="banners.html" class="menu-item">
          <span class="material-symbols-outlined">image</span>
          Banner
        </a>
        <a href="images.html" class="menu-item active">
          <span class="material-symbols-outlined">photo_library</span>
          Qu·∫£n l√Ω ·∫£nh
        </a>
        <a href="users.html" class="menu-item" id="users-menu-link">
          <span class="material-symbols-outlined">group</span>
          Ng∆∞·ªùi d√πng
        </a>
        <a href="analytics.html" class="menu-item">
          <span class="material-symbols-outlined">analytics</span>
          Th·ªëng k√™
        </a>
        <a href="../index.html" class="menu-item">
          <span class="material-symbols-outlined">home</span>
          V·ªÅ trang ch·ªß
        </a>
        <a href="#" class="menu-item" id="logout-btn">
          <span class="material-symbols-outlined">logout</span>
          ƒêƒÉng xu·∫•t
        </a>
      </nav>
      
      <div class="user-info">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div class="user-avatar" id="user-avatar"></div>
          <div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span id="user-name" style="font-size: 1.4rem; font-weight: 500;"></span>
              <span id="user-role-badge" class="role-badge role-admin"></span>
            </div>
            <div id="user-email" style="font-size: 1.2rem; color: var(--gray-400);"></div>
          </div>
        </div>
      </div>
    </aside>

    <main class="admin-main">
      <header class="admin-topbar">
        <div>
          <h1>Qu·∫£n l√Ω ·∫£nh</h1>
          <p style="font-size: 1.4rem; color: var(--gray-500); margin-top: 0.5rem;">
            Upload v√† qu·∫£n l√Ω h√¨nh ·∫£nh cho s·∫£n ph·∫©m, banner
          </p>
        </div>
        <button id="refresh-btn" class="btn btn-add">
          <span class="material-symbols-outlined">refresh</span>
          L√†m m·ªõi
        </button>
      </header>

      <div class="admin-content">
        <!-- C√†i ƒë·∫∑t API Key -->
        <div class="settings-section">
          <h3>C√†i ƒë·∫∑t ImgBB API</h3>
          <p style="color: #64748b; margin: 10px 0; font-size: 1.4rem;">
            ƒê·ªÉ upload ·∫£nh, b·∫°n c·∫ßn API key t·ª´ <a href="https://api.imgbb.com/" target="_blank" style="color: #3b82f6;">ImgBB.com</a> (mi·ªÖn ph√≠ 500 ·∫£nh/th√°ng)
          </p>
          <input type="text" id="api-key-input" class="api-key-input" 
                 placeholder="Nh·∫≠p API key c·ªßa b·∫°n (v√≠ d·ª•: a1b2c3d4e5f6g7h8i9j0)">
          <button id="save-api-btn" class="save-btn">L∆∞u API Key</button>
        </div>

        <!-- Upload Section -->
        <div class="image-upload-section">
          <h3>Upload ·∫£nh m·ªõi</h3>
          
          <div class="upload-area" id="drop-area">
            <div class="upload-icon">
              <span class="material-symbols-outlined">cloud_upload</span>
            </div>
            <h4>K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</h4>
            <p class="upload-hint">H·ªó tr·ª£ JPG, PNG, GIF (t·ªëi ƒëa 32MB)</p>
            <input type="file" id="file-input" class="file-input" accept="image/*" multiple>
            <label for="file-input" class="upload-btn">
              <span class="material-symbols-outlined">folder_open</span>
              Ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh
            </label>
          </div>
          
          <div class="progress-bar" id="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          
          <div class="status-message" id="status-message"></div>
          
          <div class="url-import">
            <h4>Ho·∫∑c import t·ª´ URL</h4>
            <div class="url-input-group">
              <input type="text" id="url-input" class="url-input" 
                     placeholder="D√°n link ·∫£nh (https://example.com/image.jpg)">
              <button id="import-btn" class="import-btn">
                <span class="material-symbols-outlined">add_link</span>
                Import
              </button>
            </div>
          </div>
        </div>

        <!-- Bulk Import Section -->
        <div class="bulk-import-section">
          <h3>Import nhi·ªÅu URL c√πng l√∫c</h3>
          <p style="color: #64748b; margin: 10px 0; font-size: 1.4rem;">
            D√°n danh s√°ch URL ·∫£nh (m·ªói URL m·ªôt d√≤ng)
          </p>
          <textarea id="bulk-urls" class="bulk-textarea" 
                    placeholder="https://i.ibb.co/abc123/image1.jpg
https://i.ibb.co/def456/image2.jpg
https://i.ibb.co/ghi789/image3.jpg"></textarea>
          <button id="bulk-import-btn" class="save-btn" style="margin-top: 10px;">
            <span class="material-symbols-outlined">add_link</span>
            Import nhi·ªÅu URL
          </button>
        </div>

        <!-- B·ªô l·ªçc -->
        <div class="filter-section">
          <div class="filter-left">
            <div class="filter-item">
              <label class="filter-label">Th·ªùi gian:</label>
              <select id="filter-time" class="filter-select">
                <option value="all">T·∫•t c·∫£ th·ªùi gian</option>
                <option value="today">H√¥m nay</option>
                <option value="yesterday">H√¥m qua</option>
                <option value="week">7 ng√†y qua</option>
                <option value="month">30 ng√†y qua</option>
                <option value="custom">T√πy ch·ªçn</option>
              </select>
            </div>
            
            <div id="custom-date-filters" style="display: none;" class="filter-item">
              <div class="date-input-group">
                <input type="date" id="date-from" class="date-input">
                <span style="font-size: 1.4rem; color: #64748b;">‚Üí</span>
                <input type="date" id="date-to" class="date-input">
              </div>
            </div>
            
            <div class="filter-item">
              <label class="filter-label">Ngu·ªìn:</label>
              <select id="filter-source" class="filter-select">
                <option value="all">T·∫•t c·∫£ ngu·ªìn</option>
                <option value="imgbb">T·ª´ ImgBB</option>
                <option value="url">T·ª´ URL</option>
              </select>
            </div>
            
            <div class="filter-item">
              <label class="filter-label">S·∫Øp x·∫øp:</label>
              <select id="sort-by" class="filter-select">
                <option value="newest">M·ªõi nh·∫•t</option>
                <option value="oldest">C≈© nh·∫•t</option>
                <option value="name_asc">T√™n A-Z</option>
                <option value="name_desc">T√™n Z-A</option>
                <option value="size_asc">K√≠ch th∆∞·ªõc (nh·ªè ‚Üí l·ªõn)</option>
                <option value="size_desc">K√≠ch th∆∞·ªõc (l·ªõn ‚Üí nh·ªè)</option>
              </select>
            </div>
          </div>
          
          <div class="filter-actions">
            <button id="apply-filter" class="btn-filter">
              <span class="material-symbols-outlined">filter_alt</span>
              L·ªçc
            </button>
            <button id="reset-filter" class="btn-reset">
              <span class="material-symbols-outlined">restart_alt</span>
              ƒê·∫∑t l·∫°i
            </button>
          </div>
        </div>

        <!-- Image Gallery -->
        <h3 style="margin: 30px 0 15px 0;">
          Th∆∞ vi·ªán ·∫£nh (<span id="image-count">0</span> ·∫£nh)
          <span id="filter-stats" class="image-stats"></span>
        </h3>
        <div class="image-grid" id="image-grid">
          <!-- ·∫¢nh s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
        </div>
        
        <div style="text-align: center; margin: 40px 0; color: #64748b;">
          <p>üí° M·∫πo: Click v√†o link ·∫£nh ƒë·ªÉ copy, sau ƒë√≥ d√°n v√†o form s·∫£n ph·∫©m</p>
        </div>
      </div>
    </main>
  </div>

<script type="module">
  // ========== FIREBASE IMPORT ==========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signOut 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    getDocs, 
    addDoc,
    deleteDoc,
    doc,
    query,
    where,
    orderBy,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC0ua4VVMCYnJa2ndQ2MMgDYPNdCEfoxwY",
    authDomain: "products-a39df.firebaseapp.com",
    projectId: "products-a39df",
    storageBucket: "products-a39df.firebasestorage.app",
    messagingSenderId: "708345988066",
    appId: "1:708345988066:web:b8011a4859285450162fbb"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ========== AUTH CHECK ==========
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = '../a1b2c3-secret.html';
      return;
    }
    
    try {
      // Ki·ªÉm tra admin
      const adminsRef = collection(db, "admins");
      const q = query(adminsRef, where("email", "==", user.email));
      const snapshot = await getDocs(q);
      
      if (snapshot.empty) {
        await signOut(auth);
        alert("‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p Admin Panel!");
        window.location.href = '../a1b2c3-secret.html';
        return;
      }
      
      // Hi·ªÉn th·ªã th√¥ng tin user
      const adminData = snapshot.docs[0].data();
      document.getElementById('user-name').textContent = adminData.name || user.displayName || 'Admin';
      document.getElementById('user-email').textContent = user.email;
      document.getElementById('user-avatar').textContent = 
        (adminData.name?.charAt(0) || user.email.charAt(0)).toUpperCase();
      
      // Hi·ªÉn th·ªã role
      const roleBadge = document.getElementById('user-role-badge');
      if (adminData.role === 'super_admin') {
        roleBadge.textContent = 'Super Admin';
        roleBadge.className = 'role-badge role-super_admin';
      } else if (adminData.role === 'admin') {
        roleBadge.textContent = 'Admin';
        roleBadge.className = 'role-badge role-admin';
      } else if (adminData.role === 'staff') {
        roleBadge.textContent = 'Nh√¢n vi√™n';
        roleBadge.className = 'role-badge role-staff';
      }
      
      // Kh·ªüi t·∫°o qu·∫£n l√Ω ·∫£nh
      initImageManager();
      
    } catch (error) {
      console.error("‚ùå Admin check error:", error);
      window.location.href = '../a1b2c3-secret.html';
    }
  });

  // ========== LOGOUT ==========
  document.getElementById('logout-btn').addEventListener('click', async () => {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
      try {
        await signOut(auth);
        window.location.href = '../a1b2c3-secret.html';
      } catch (error) {
        console.error("Error logging out:", error);
        alert("L·ªói ƒëƒÉng xu·∫•t: " + error.message);
      }
    }
  });

  // ========== H·ªÜ TH·ªêNG QU·∫¢N L√ù ·∫¢NH V·ªöI L·ªåC THEO TH·ªúI GIAN ==========
  async function initImageManager() {
    // DOM Elements
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const urlInput = document.getElementById('url-input');
    const importBtn = document.getElementById('import-btn');
    const imageGrid = document.getElementById('image-grid');
    const imageCount = document.getElementById('image-count');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const statusMessage = document.getElementById('status-message');
    const apiKeyInput = document.getElementById('api-key-input');
    const saveApiBtn = document.getElementById('save-api-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const bulkImportBtn = document.getElementById('bulk-import-btn');
    const bulkUrls = document.getElementById('bulk-urls');
    const filterStats = document.getElementById('filter-stats');
    
    // Filter elements
    const filterTime = document.getElementById('filter-time');
    const customDateFilters = document.getElementById('custom-date-filters');
    const dateFrom = document.getElementById('date-from');
    const dateTo = document.getElementById('date-to');
    const filterSource = document.getElementById('filter-source');
    const sortBy = document.getElementById('sort-by');
    const applyFilter = document.getElementById('apply-filter');
    const resetFilter = document.getElementById('reset-filter');
    
    // Bi·∫øn to√†n c·ª•c
    let allImages = [];
    let displayedImages = [];
    let imgbbApiKey = localStorage.getItem('imgbb_api_key') || '';
    let currentFilter = {
      time: 'all',
      source: 'all',
      sort: 'newest',
      dateFrom: '',
      dateTo: ''
    };
    
    // Bi·∫øn ƒë·ªÉ x·ª≠ l√Ω file upload (FIX L·ªñI)
    let isProcessingFiles = false;

    // ========== T·∫¢I ·∫¢NH T·ª™ FIRESTORE ==========
    async function loadImages() {
      try {
        showStatus('ƒêang t·∫£i ·∫£nh...', '');
        
        const q = query(collection(db, "images"), orderBy("uploadedAt", "desc"));
        const querySnapshot = await getDocs(q);
        
        allImages = [];
        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          allImages.push({
            id: docSnap.id,
            ...data
          });
        });
        
        // C·∫≠p nh·∫≠t ng√†y m·∫∑c ƒë·ªãnh cho filter
        updateDefaultDates();
        applyFilters();
        showStatus('', '');
        
      } catch (error) {
        console.error("‚ùå L·ªói t·∫£i ·∫£nh:", error);
        showStatus('‚ùå L·ªói t·∫£i ·∫£nh: ' + error.message, 'error');
      }
    }

    // ========== C·∫¨P NH·∫¨T NG√ÄY M·∫∂C ƒê·ªäNH ==========
    function updateDefaultDates() {
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      // ƒê·ªãnh d·∫°ng YYYY-MM-DD
      const formatDate = (date) => date.toISOString().split('T')[0];
      
      dateTo.value = formatDate(today);
      dateFrom.value = formatDate(yesterday);
    }

    // ========== √ÅP D·ª§NG B·ªò L·ªåC ==========
    function applyFilters() {
      // Sao ch√©p m·∫£ng ·∫£nh
      displayedImages = [...allImages];
      
      // L·ªçc theo th·ªùi gian
      if (currentFilter.time !== 'all') {
        const now = new Date();
        let startDate = new Date();
        let endDate = new Date();
        
        switch(currentFilter.time) {
          case 'today':
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            break;
          case 'yesterday':
            startDate.setDate(startDate.getDate() - 1);
            startDate.setHours(0, 0, 0, 0);
            endDate = new Date(startDate);
            endDate.setHours(23, 59, 59, 999);
            break;
          case 'week':
            startDate.setDate(startDate.getDate() - 7);
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            break;
          case 'month':
            startDate.setDate(startDate.getDate() - 30);
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            break;
          case 'custom':
            if (currentFilter.dateFrom && currentFilter.dateTo) {
              startDate = new Date(currentFilter.dateFrom);
              startDate.setHours(0, 0, 0, 0);
              endDate = new Date(currentFilter.dateTo);
              endDate.setHours(23, 59, 59, 999);
            }
            break;
        }
        
        if (currentFilter.time !== 'all') {
          displayedImages = displayedImages.filter(img => {
            if (!img.uploadedAt) return false;
            const imgDate = new Date(img.uploadedAt);
            return imgDate >= startDate && imgDate <= endDate;
          });
        }
      }
      
      // L·ªçc theo ngu·ªìn
      if (currentFilter.source !== 'all') {
        displayedImages = displayedImages.filter(img => img.source === currentFilter.source);
      }
      
      // S·∫Øp x·∫øp
      displayedImages.sort((a, b) => {
        switch(currentFilter.sort) {
          case 'oldest':
            return new Date(a.uploadedAt || 0) - new Date(b.uploadedAt || 0);
          case 'name_asc':
            return (a.name || '').localeCompare(b.name || '');
          case 'name_desc':
            return (b.name || '').localeCompare(a.name || '');
          case 'size_asc':
            return (a.size || 0) - (b.size || 0);
          case 'size_desc':
            return (b.size || 0) - (a.size || 0);
          default: // 'newest'
            return new Date(b.uploadedAt || 0) - new Date(a.uploadedAt || 0);
        }
      });
      
      // C·∫≠p nh·∫≠t th·ªëng k√™ b·ªô l·ªçc
      updateFilterStats();
      
      // Render ·∫£nh
      renderImages();
    }

    // ========== C·∫¨P NH·∫¨T TH·ªêNG K√ä B·ªò L·ªåC ==========
    function updateFilterStats() {
      let stats = [];
      
      // Th·ªùi gian
      if (currentFilter.time !== 'all') {
        const timeNames = {
          'today': 'H√¥m nay',
          'yesterday': 'H√¥m qua',
          'week': '7 ng√†y qua',
          'month': '30 ng√†y qua',
          'custom': `T·ª´ ${formatDisplayDate(currentFilter.dateFrom)} ƒë·∫øn ${formatDisplayDate(currentFilter.dateTo)}`
        };
        stats.push(`Th·ªùi gian: ${timeNames[currentFilter.time]}`);
      }
      
      // Ngu·ªìn
      if (currentFilter.source !== 'all') {
        const sourceNames = {
          'imgbb': 'ImgBB',
          'url': 'URL'
        };
        stats.push(`Ngu·ªìn: ${sourceNames[currentFilter.source]}`);
      }
      
      // S·∫Øp x·∫øp
      if (currentFilter.sort !== 'newest') {
        const sortNames = {
          'oldest': 'C≈© nh·∫•t',
          'name_asc': 'T√™n A-Z',
          'name_desc': 'T√™n Z-A',
          'size_asc': 'K√≠ch th∆∞·ªõc tƒÉng d·∫ßn',
          'size_desc': 'K√≠ch th∆∞·ªõc gi·∫£m d·∫ßn'
        };
        stats.push(`S·∫Øp x·∫øp: ${sortNames[currentFilter.sort]}`);
      }
      
      filterStats.textContent = stats.length > 0 ? `(${stats.join(' | ')})` : '';
    }

    // ========== ƒê·ªäNH D·∫†NG NG√ÄY HI·ªÇN TH·ªä ==========
    function formatDisplayDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN');
      } catch {
        return '';
      }
    }

    // ========== X√ìA ·∫¢NH ==========
    async function deleteImage(imageId) {
      try {
        // X√≥a trong Firebase
        await deleteDoc(doc(db, "images", imageId));
        
        // X√≥a kh·ªèi m·∫£ng allImages
        const index = allImages.findIndex(img => img.id === imageId);
        if (index > -1) {
          allImages.splice(index, 1);
        }
        
        applyFilters();
        return true;
      } catch (error) {
        console.error("‚ùå L·ªói x√≥a ·∫£nh:", error);
        throw error;
      }
    }

    // ========== UPLOAD ·∫¢NH L√äN IMGBB ==========
    async function uploadToImgBB(file) {
      if (!imgbbApiKey) {
        throw new Error('Vui l√≤ng nh·∫≠p ImgBB API key trong ph·∫ßn c√†i ƒë·∫∑t');
      }
      
      const formData = new FormData();
      formData.append('image', file);
      formData.append('key', imgbbApiKey);
      
      const response = await fetch('https://api.imgbb.com/1/upload', {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) {
        throw new Error(`L·ªói upload: HTTP ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.success) {
        return {
          url: data.data.url,
          thumb: data.data.thumb?.url || data.data.url,
          medium: data.data.medium?.url || data.data.url,
          name: file.name,
          size: file.size,
          uploadedAt: new Date().toISOString(),
          source: 'imgbb'
        };
      } else {
        throw new Error(data.error?.message || 'Upload th·∫•t b·∫°i');
      }
    }

    // ========== L∆ØU ·∫¢NH V√ÄO FIRESTORE ==========
    async function saveImageToFirebase(imageData) {
      try {
        const docRef = await addDoc(collection(db, "images"), {
          ...imageData,
          uploadedAt: serverTimestamp()
        });
        
        // Th√™m v√†o m·∫£ng allImages v·ªõi id m·ªõi
        imageData.id = docRef.id;
        allImages.unshift(imageData);
        applyFilters();
        
        return imageData;
      } catch (error) {
        console.error("‚ùå L·ªói l∆∞u ·∫£nh:", error);
        throw error;
      }
    }

    // ========== RENDER ·∫¢NH ==========
    function renderImages() {
      const imagesToRender = displayedImages.length > 0 ? displayedImages : allImages;
      imageCount.textContent = imagesToRender.length;
      
      if (imagesToRender.length === 0) {
        imageGrid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #64748b;">
            <span class="material-symbols-outlined" style="font-size: 48px; margin-bottom: 15px;">
              photo_library
            </span>
            <h4>Kh√¥ng t√¨m th·∫•y ·∫£nh</h4>
            <p>Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c upload ·∫£nh m·ªõi</p>
          </div>
        `;
        return;
      }
      
      imageGrid.innerHTML = imagesToRender.map((img) => `
        <div class="image-card">
          <img src="${img.thumb || img.url}" 
               alt="${img.name}" 
               class="image-preview"
               loading="lazy"
               onerror="this.src='https://via.placeholder.com/200x150?text=L·ªói+·∫£nh'">
          <div class="image-info">
            <div style="font-size: 1.3rem; font-weight: 500; margin-bottom: 5px;">
              ${(img.name || '·∫¢nh').substring(0, 20)}${(img.name || '·∫¢nh').length > 20 ? '...' : ''}
            </div>
            <div style="font-size: 1.2rem; color: #94a3b8;">
              ${formatFileSize(img.size || 0)} ‚Ä¢ ${formatDate(img.uploadedAt)}
              ${img.source === 'imgbb' ? '<span style="color: #3b82f6;">‚Ä¢ ImgBB</span>' : 
                img.source === 'url' ? '<span style="color: #10b981;">‚Ä¢ URL</span>' : ''}
            </div>
            <div class="image-url" title="Click ƒë·ªÉ copy" data-url="${img.url}">
              ${img.url.substring(0, 40)}${img.url.length > 40 ? '...' : ''}
            </div>
            <div class="image-actions">
              <button class="copy-btn" data-url="${img.url}">
                <span class="material-symbols-outlined">content_copy</span>
                Copy
              </button>
              <button class="delete-btn" data-id="${img.id}">
                <span class="material-symbols-outlined">delete</span>
                X√≥a
              </button>
            </div>
          </div>
        </div>
      `).join('');
      
      // Event listeners cho c√°c n√∫t
      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const url = this.getAttribute('data-url');
          copyToClipboard(url);
        });
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.getAttribute('data-id');
          const image = allImages.find(img => img.id === id);
          
          let confirmMsg = 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?\n';
          if (image?.source === 'imgbb') {
            confirmMsg += '\n‚ö†Ô∏è L∆∞u √Ω: ·∫¢nh n√†y ƒë∆∞·ª£c l∆∞u tr√™n ImgBB. V·ªõi g√≥i mi·ªÖn ph√≠, ·∫£nh s·∫Ω v·∫´n t·ªìn t·∫°i tr√™n ImgBB v√† ch·ªâ b·ªã x√≥a kh·ªèi c∆° s·ªü d·ªØ li·ªáu c·ªßa b·∫°n.';
          }
          
          if (confirm(confirmMsg)) {
            try {
              showStatus('ƒêang x√≥a...', '');
              await deleteImage(id);
              showStatus('‚úÖ ƒê√£ x√≥a ·∫£nh kh·ªèi database', 'success');
              setTimeout(() => showStatus(''), 2000);
            } catch (error) {
              showStatus('‚ùå L·ªói x√≥a ·∫£nh: ' + error.message, 'error');
            }
          }
        });
      });
      
      document.querySelectorAll('.image-url').forEach(div => {
        div.addEventListener('click', function() {
          const url = this.getAttribute('data-url');
          copyToClipboard(url);
        });
      });
    }

    // ========== IMPORT T·ª™ URL (ƒê∆†N) ==========
    async function importImageFromUrl(url) {
      if (!url.startsWith('http')) {
        throw new Error('URL kh√¥ng h·ª£p l·ªá');
      }
      
      const imageData = {
        url: url,
        thumb: url,
        medium: url,
        name: `Import t·ª´ URL - ${new Date().toLocaleDateString('vi-VN')}`,
        size: 0,
        uploadedAt: new Date().toISOString(),
        source: 'url'
      };
      
      return await saveImageToFirebase(imageData);
    }

    // ========== IMPORT NHI·ªÄU URL ==========
    async function bulkImportUrls() {
      const urlsText = bulkUrls.value.trim();
      if (!urlsText) {
        showStatus('Vui l√≤ng nh·∫≠p danh s√°ch URL', 'error');
        return;
      }
      
      const urls = urlsText.split('\n')
        .map(url => url.trim())
        .filter(url => url.startsWith('http'));
      
      if (urls.length === 0) {
        showStatus('Kh√¥ng t√¨m th·∫•y URL h·ª£p l·ªá', 'error');
        return;
      }
      
      bulkImportBtn.disabled = true;
      bulkImportBtn.innerHTML = '<span class="material-symbols-outlined">sync</span> ƒêang import...';
      
      showStatus(`ƒêang import ${urls.length} URL...`, '');
      
      let imported = 0;
      let errors = 0;
      
      for (const url of urls) {
        try {
          await importImageFromUrl(url);
          imported++;
          
          if (imported % 5 === 0) {
            showStatus(`ƒê√£ import ${imported}/${urls.length} URL...`);
          }
        } catch (error) {
          errors++;
          console.error(`‚ùå L·ªói import ${url}:`, error);
        }
      }
      
      bulkImportBtn.disabled = false;
      bulkImportBtn.innerHTML = '<span class="material-symbols-outlined">add_link</span> Import nhi·ªÅu URL';
      
      showStatus(`‚úÖ ƒê√£ import ${imported} URL th√†nh c√¥ng, ${errors} l·ªói.`, 'success');
      bulkUrls.value = '';
    }

    // ========== UPLOAD NHI·ªÄU FILE ==========
    async function handleFiles(files) {
      const validFiles = Array.from(files).filter(file => {
        if (!file.type.startsWith('image/')) {
          showStatus(`File ${file.name} kh√¥ng ph·∫£i l√† ·∫£nh`, 'error');
          return false;
        }
        if (file.size > 32 * 1024 * 1024) {
          showStatus(`File ${file.name} qu√° l·ªõn (t·ªëi ƒëa 32MB)`, 'error');
          return false;
        }
        return true;
      });
      
      if (validFiles.length === 0) return;
      
      showStatus(`ƒêang upload ${validFiles.length} ·∫£nh...`, '');
      progressBar.style.display = 'block';
      progressFill.style.width = '0%';
      
      let uploaded = 0;
      
      for (const file of validFiles) {
        try {
          // Upload l√™n ImgBB
          showStatus(`ƒêang upload ${file.name}...`);
          const imgbbResult = await uploadToImgBB(file);
          
          // L∆∞u v√†o Firebase
          await saveImageToFirebase(imgbbResult);
          
          uploaded++;
          const progress = Math.round((uploaded / validFiles.length) * 100);
          progressFill.style.width = `${progress}%`;
          showStatus(`ƒê√£ upload ${uploaded}/${validFiles.length} ·∫£nh...`);
          
        } catch (error) {
          showStatus(`‚ùå L·ªói upload ${file.name}: ${error.message}`, 'error');
        }
      }
      
      if (uploaded > 0) {
        showStatus(`‚úÖ ƒê√£ upload th√†nh c√¥ng ${uploaded} ·∫£nh!`, 'success');
        
        setTimeout(() => {
          progressBar.style.display = 'none';
          progressFill.style.width = '0%';
          showStatus('');
        }, 3000);
      }
    }

    // ========== DRAG AND DROP ==========
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => {
        dropArea.classList.add('dragover');
      }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => {
        dropArea.classList.remove('dragover');
      }, false);
    });
    
    dropArea.addEventListener('drop', handleDrop, false);
    dropArea.addEventListener('click', () => fileInput.click());
    
    // ========== FIX L·ªñI FILE INPUT ==========
    fileInput.addEventListener('change', async (e) => {
      // Ch·∫∑n g·ªçi nhi·ªÅu l·∫ßn
      if (isProcessingFiles) {
        console.log('ƒêang x·ª≠ l√Ω files, b·ªè qua s·ª± ki·ªán m·ªõi');
        return;
      }
      
      isProcessingFiles = true;
      
      try {
        await handleFiles(e.target.files);
      } catch (error) {
        console.error('L·ªói x·ª≠ l√Ω files:', error);
        showStatus('‚ùå L·ªói x·ª≠ l√Ω ·∫£nh: ' + error.message, 'error');
      } finally {
        // Reset input file
        fileInput.value = '';
        
        // Cho ph√©p x·ª≠ l√Ω ti·∫øp sau 500ms ƒë·ªÉ tr√°nh xung ƒë·ªôt
        setTimeout(() => {
          isProcessingFiles = false;
        }, 500);
      }
    });
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (isProcessingFiles) {
        console.log('ƒêang x·ª≠ l√Ω files, b·ªè qua drop m·ªõi');
        return;
      }
      
      isProcessingFiles = true;
      
      try {
        handleFiles(files);
      } catch (error) {
        console.error('L·ªói x·ª≠ l√Ω drop:', error);
        showStatus('‚ùå L·ªói x·ª≠ l√Ω drop: ' + error.message, 'error');
      } finally {
        setTimeout(() => {
          isProcessingFiles = false;
        }, 500);
      }
    }
    
    // Th√™m event listener cho label ƒë·ªÉ ngƒÉn s·ª± ki·ªán lan
    const uploadLabel = document.querySelector('label[for="file-input"]');
    if (uploadLabel) {
      uploadLabel.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }

    // ========== EVENT LISTENERS CHO B·ªò L·ªåC ==========
    // Hi·ªÉn th·ªã/·∫©n b·ªô l·ªçc t√πy ch·ªânh theo th·ªùi gian
    filterTime.addEventListener('change', function() {
      if (this.value === 'custom') {
        customDateFilters.style.display = 'flex';
      } else {
        customDateFilters.style.display = 'none';
      }
      currentFilter.time = this.value;
      applyFilters();
    });
    
    dateFrom.addEventListener('change', function() {
      currentFilter.dateFrom = this.value;
      if (currentFilter.time === 'custom') {
        applyFilters();
      }
    });
    
    dateTo.addEventListener('change', function() {
      currentFilter.dateTo = this.value;
      if (currentFilter.time === 'custom') {
        applyFilters();
      }
    });
    
    filterSource.addEventListener('change', function() {
      currentFilter.source = this.value;
      applyFilters();
    });
    
    sortBy.addEventListener('change', function() {
      currentFilter.sort = this.value;
      applyFilters();
    });
    
    applyFilter.addEventListener('click', () => {
      applyFilters();
    });
    
    resetFilter.addEventListener('click', () => {
      // Reset t·∫•t c·∫£ filter
      filterTime.value = 'all';
      filterSource.value = 'all';
      sortBy.value = 'newest';
      customDateFilters.style.display = 'none';
      updateDefaultDates();
      
      currentFilter = {
        time: 'all',
        source: 'all',
        sort: 'newest',
        dateFrom: '',
        dateTo: ''
      };
      
      applyFilters();
    });

    // ========== EVENT LISTENERS KH√ÅC ==========
    saveApiBtn.addEventListener('click', () => {
      const key = apiKeyInput.value.trim();
      if (!key) {
        showStatus('Vui l√≤ng nh·∫≠p API key', 'error');
        return;
      }
      
      imgbbApiKey = key;
      localStorage.setItem('imgbb_api_key', key);
      showStatus('‚úÖ ƒê√£ l∆∞u API key!', 'success');
      
      setTimeout(() => showStatus(''), 3000);
    });
    
    importBtn.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      if (!url) {
        showStatus('Vui l√≤ng nh·∫≠p URL ·∫£nh', 'error');
        return;
      }
      
      if (!url.startsWith('http')) {
        showStatus('URL kh√¥ng h·ª£p l·ªá', 'error');
        return;
      }
      
      try {
        showStatus('ƒêang import ·∫£nh...', '');
        await importImageFromUrl(url);
        showStatus('‚úÖ ƒê√£ import ·∫£nh t·ª´ URL!', 'success');
        urlInput.value = '';
      } catch (error) {
        showStatus('‚ùå L·ªói import: ' + error.message, 'error');
      }
    });
    
    urlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        importBtn.click();
      }
    });
    
    refreshBtn.addEventListener('click', async () => {
      showStatus('ƒêang l√†m m·ªõi danh s√°ch ·∫£nh...', '');
      try {
        await loadImages();
        showStatus('‚úÖ ƒê√£ l√†m m·ªõi danh s√°ch ·∫£nh!', 'success');
        setTimeout(() => showStatus(''), 2000);
      } catch (error) {
        showStatus('‚ùå L·ªói l√†m m·ªõi: ' + error.message, 'error');
      }
    });
    
    bulkImportBtn.addEventListener('click', bulkImportUrls);

    // ========== HELPER FUNCTIONS ==========
    function showStatus(message, type = '') {
      statusMessage.textContent = message;
      statusMessage.className = 'status-message ' + type;
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN');
      } catch (error) {
        return 'N/A';
      }
    }
    
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        showStatus('‚úÖ ƒê√£ copy link ·∫£nh!', 'success');
        setTimeout(() => showStatus(''), 2000);
      } catch (err) {
        // Fallback cho tr√¨nh duy·ªát c≈©
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showStatus('‚úÖ ƒê√£ copy link ·∫£nh!', 'success');
        setTimeout(() => showStatus(''), 2000);
      }
    }

    // ========== KH·ªûI T·∫†O ==========
    async function init() {
      try {
        // Load API key
        apiKeyInput.value = imgbbApiKey;
        
        // C·∫≠p nh·∫≠t ng√†y m·∫∑c ƒë·ªãnh
        updateDefaultDates();
        
        // Load ·∫£nh t·ª´ Firebase
        await loadImages();
        
        // Ki·ªÉm tra API key
        if (!imgbbApiKey) {
          showStatus('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ImgBB API key ƒë·ªÉ upload ·∫£nh', 'warning');
        } else {
          showStatus('‚úÖ S·∫µn s√†ng upload ·∫£nh!', 'success');
          setTimeout(() => showStatus(''), 3000);
        }
      } catch (error) {
        console.error("L·ªói kh·ªüi t·∫°o:", error);
        showStatus('‚ö†Ô∏è H·ªá th·ªëng ƒëang ch·∫°y ·ªü ch·∫ø ƒë·ªô offline', 'warning');
      }
    }
    
    // G·ªçi init
    init();
  }
</script>
</body>
</html>