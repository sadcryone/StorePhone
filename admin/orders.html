<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"/>
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng - Store Phone Admin</title>
    <link rel="stylesheet" href="./assets/css/admin.css">
    <link rel="stylesheet" href="./assets/css/orders.css">
    <style>
        .order-count-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .display-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .order-stats {
            display: flex;
            gap: 20px;
        }
        
        .order-stats .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 20px;
            background: var(--gray-50);
            border-radius: 6px;
            min-width: 120px;
        }
        
        .order-stats .stat-value {
            font-size: 2.4rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }
        
        .order-stats .stat-label {
            font-size: 1.2rem;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <!-- MOBILE MENU TOGGLE -->
    <button class="menu-toggle" id="menu-toggle">
        <span class="material-symbols-outlined">menu</span>
    </button>

    <div class="admin-layout">
        <!-- SIDEBAR -->
        <aside class="admin-sidebar" id="admin-sidebar">
            <div class="sidebar-header">
                <h2>STORE PHONE</h2>
                <p>Admin Dashboard</p>
            </div>
            
            <nav class="sidebar-menu">
                <a href="index.html" class="menu-item">
                    <span class="material-symbols-outlined">inventory_2</span>
                    S·∫£n ph·∫©m
                </a>
                <a href="orders.html" class="menu-item active">
                    <span class="material-symbols-outlined">shopping_bag</span>
                    ƒê∆°n h√†ng
                </a>
                <a href="chats.html" class="menu-item">
                    <span class="material-symbols-outlined">chat</span>
                    Qu·∫£n l√Ω Chat
                </a>
                <a href="banners.html" class="menu-item">
                    <span class="material-symbols-outlined">image</span>
                    Banner
                </a>
                <a href="images.html" class="menu-item">
                    <span class="material-symbols-outlined">photo_library</span>
                    Qu·∫£n l√Ω ·∫£nh
                </a>
                <a href="users.html" class="menu-item" id="users-menu-link">
                    <span class="material-symbols-outlined">group</span>
                    Ng∆∞·ªùi d√πng
                </a>
                <a href="analytics.html" class="menu-item">
                    <span class="material-symbols-outlined">analytics</span>
                    Th·ªëng k√™
                </a>
                <a href="../index.html" class="menu-item">
                    <span class="material-symbols-outlined">home</span>
                    V·ªÅ trang ch·ªß
                </a>
                <a href="#" class="menu-item" id="logout-btn">
                    <span class="material-symbols-outlined">logout</span>
                    ƒêƒÉng xu·∫•t
                </a>
            </nav>
            
            <div class="user-info">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="user-name" style="font-size: 1.4rem; font-weight: 500;"></span>
                            <span id="user-role-badge" class="role-badge role-admin"></span>
                        </div>
                        <div id="user-email" style="font-size: 1.2rem; color: var(--gray-400);"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="admin-main">
            <!-- TOP BAR -->
            <header class="admin-topbar">
                <h1>Qu·∫£n l√Ω ƒë∆°n h√†ng</h1>
            </header>

            <!-- CONTENT AREA -->
            <div class="admin-content">
                <!-- ORDER COUNT INFO with Stats -->
                <div class="order-count-info">
                    <div class="display-info">
                        <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">filter_list</span>
                        ƒêang hi·ªÉn th·ªã: <strong id="showing-orders">0</strong> ƒë∆°n h√†ng
                        <div class="filter-tags" id="filter-tags">
                            <!-- C√°c filter tag s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                        </div>
                    </div>
                    
                    <div class="order-stats">
                        <div class="stat-item">
                            <span class="stat-value" id="total-orders">0</span>
                            <span class="stat-label">
                                <span class="material-symbols-outlined" style="font-size: 1.4rem;">shopping_bag</span>
                                T·ªïng ƒë∆°n h√†ng
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="pending-orders">0</span>
                            <span class="stat-label">
                                <span class="material-symbols-outlined" style="font-size: 1.4rem;">schedule</span>
                                Ch·ªù x·ª≠ l√Ω
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="today-orders">0</span>
                            <span class="stat-label">
                                <span class="material-symbols-outlined" style="font-size: 1.4rem;">today</span>
                                H√¥m nay
                            </span>
                        </div>
                    </div>
                </div>

                <!-- QUICK TOOLBAR -->
                <div class="quick-toolbar">
                    <button class="toolbar-btn" onclick="refreshOrders()">
                        <span class="material-symbols-outlined">refresh</span>
                        L√†m m·ªõi
                    </button>
                    <button class="toolbar-btn" onclick="printOrders()">
                        <span class="material-symbols-outlined">print</span>
                        In danh s√°ch
                    </button>
                </div>

                <!-- DATE RANGE & FILTERS -->
                <div class="advanced-filter">
                    <div class="filter-group">
                        <label>T·ª´ ng√†y</label>
                        <input type="date" id="start-date" class="date-input">
                    </div>
                    <div class="filter-group">
                        <label>ƒê·∫øn ng√†y</label>
                        <input type="date" id="end-date" class="date-input">
                    </div>
                    <div class="filter-group">
                        <label>Tr·∫°ng th√°i</label>
                        <select id="status-filter">
                            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                            <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                            <option value="shipping">ƒêang chuy·ªÉn h√†ng</option>
                            <option value="delivering">ƒêang giao h√†ng</option>
                            <option value="success">Th√†nh c√¥ng</option>
                            <option value="cancelled">ƒê√£ hu·ª∑</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Thanh to√°n</label>
                        <select id="payment-filter">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="paid">ƒê√£ thanh to√°n</option>
                            <option value="unpaid">Ch∆∞a thanh to√°n</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>S·∫Øp x·∫øp</label>
                        <select id="sort-by">
                            <option value="created_desc">M·ªõi nh·∫•t</option>
                            <option value="created_asc">C≈© nh·∫•t</option>
                            <option value="total_desc">Gi√° tr·ªã cao</option>
                            <option value="total_asc">Gi√° tr·ªã th·∫•p</option>
                        </select>
                    </div>
                </div>

                <!-- SEARCH -->
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="T√¨m theo m√£ ƒë∆°n, t√™n kh√°ch h√†ng, SƒêT, email...">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <span class="material-symbols-outlined">search</span>
                        T√¨m ki·∫øm
                    </button>
                </div>

                <!-- ORDERS TABLE -->
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>M√£ ƒë∆°n h√†ng</th>
                                <th>Ng√†y ƒë·∫∑t</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                                <th>T·ªïng ti·ªÅn</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thanh to√°n</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="orders-list">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- LOADING STATE -->
                <div class="loading" id="loading-state">
                    <div class="loading-spinner"></div>
                    <p>ƒêang t·∫£i ƒë∆°n h√†ng...</p>
                </div>

                <!-- EMPTY STATE -->
                <div style="text-align: center; padding: 60px; display: none;" id="empty-state">
                    <span class="material-symbols-outlined" style="font-size: 60px; color: var(--gray-300);">
                        search_off
                    </span>
                    <h3 style="font-size: 1.8rem; color: var(--gray-500); margin: 1rem 0;">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng</h3>
                    <p style="color: var(--gray-400); margin-bottom: 2rem;">H√£y th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c th√™m ƒë∆°n h√†ng m·ªõi</p>
                </div>

                <!-- PAGINATION -->
                <div class="pagination">
                    <div>
                        Hi·ªÉn th·ªã 
                        <select id="per-page" onchange="changePerPage(this.value)" style="padding: 0.4rem; margin: 0 0.5rem;">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select> 
                        ƒë∆°n h√†ng/trang
                    </div>
                    <div class="page-controls">
                        <button id="prev-page" onclick="prevPage()" disabled>‚Äπ Tr∆∞·ªõc</button>
                        <span id="page-info">Trang 1/1</span>
                        <button id="next-page" onclick="nextPage()" disabled>Sau ‚Ä∫</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ORDER DETAILS MODAL -->
    <div class="order-details-modal" id="order-details-modal">
        <div class="order-details-content">
            <div class="details-header">
                <h2 style="margin: 0; font-size: 2rem; font-weight: 600;">Chi ti·∫øt ƒë∆°n h√†ng</h2>
                <button id="close-details" style="background: none; border: none; color: white; font-size: 3rem; cursor: pointer; line-height: 1;">&times;</button>
            </div>
            <div class="details-body">
                <!-- Content s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
            </div>
        </div>
    </div>

    <script type="module">
    // ========== FIREBASE CONFIG ==========
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        getDocs, 
        query,
        where,
        doc,
        updateDoc,
        serverTimestamp,
        deleteDoc,
        getDoc,
        increment
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0ua4VVMCYnJa2ndQ2MMgDYPNdCEfoxwY",
        authDomain: "products-a39df.firebaseapp.com",
        projectId: "products-a39df",
        storageBucket: "products-a39df.firebasestorage.app",
        messagingSenderId: "708345988066",
        appId: "1:708345988066:web:b8011a4859285450162fbb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ========== GLOBAL VARIABLES ==========
    let orders = [];
    let filteredOrders = [];
    let currentPage = 1;
    let itemsPerPage = 10;
    let totalPages = 1;
    let currentSort = 'created_desc';
    let currentFilters = {
        startDate: '',
        endDate: '',
        status: '',
        payment: '',
        search: ''
    };
    let currentUserRole = '';

    // ========== MOBILE MENU TOGGLE ==========
    document.getElementById('menu-toggle').addEventListener('click', () => {
        const sidebar = document.getElementById('admin-sidebar');
        sidebar.classList.toggle('active');
    });

    // ========== AUTH CHECK ==========
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = '../a1b2c3-secret.html';
            return;
        }
        
        try {
            const adminsRef = collection(db, "admins");
            const q = query(adminsRef, where("email", "==", user.email));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                await signOut(auth);
                alert("‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p Admin Panel!");
                window.location.href = '../a1b2c3-secret.html';
                return;
            }
            
            const userData = snapshot.docs[0].data();
            currentUserRole = userData.role || 'admin';
            
            document.getElementById('user-name').textContent = userData.name || user.displayName || 'User';
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-avatar').textContent = 
                (userData.name?.charAt(0) || user.email.charAt(0)).toUpperCase();
            
            const roleBadge = document.getElementById('user-role-badge');
            if (currentUserRole === 'super_admin') {
                roleBadge.textContent = 'Super Admin';
                roleBadge.className = 'role-badge role-super_admin';
            } else if (currentUserRole === 'admin') {
                roleBadge.textContent = 'Admin';
                roleBadge.className = 'role-badge role-admin';
            } else if (currentUserRole === 'staff') {
                roleBadge.textContent = 'Nh√¢n vi√™n';
                roleBadge.className = 'role-badge role-staff';
            }
            
            await loadOrders();
            setupMenuPermissions();
            
        } catch (error) {
            console.error("L·ªói x√°c th·ª±c:", error);
            window.location.href = '../a1b2c3-secret.html';
        }
    });

    function setupMenuPermissions() {
        const usersMenuLink = document.getElementById('users-menu-link');
        
        if (usersMenuLink) {
            usersMenuLink.addEventListener('click', function(e) {
                if (currentUserRole === 'staff') {
                    e.preventDefault();
                    alert("‚ùå Ch·ªâ qu·∫£n tr·ªã vi√™n m·ªõi ƒë∆∞·ª£c truy c·∫≠p trang Qu·∫£n l√Ω Ng∆∞·ªùi d√πng!");
                    return false;
                }
                return true;
            });
        }
    }

    // ========== ORDER MANAGEMENT ==========
    async function loadOrders() {
        try {
            showLoading(true);
            
            const ordersRef = collection(db, "orders");
            const snapshot = await getDocs(ordersRef);
            
            orders = [];
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                
                // X·ª≠ l√Ω timestamp cho createdAt
                let createdAtDate;
                if (data.createdAt) {
                    if (typeof data.createdAt.toDate === 'function') {
                        createdAtDate = data.createdAt.toDate();
                    } else if (data.createdAt.seconds) {
                        createdAtDate = new Date(data.createdAt.seconds * 1000);
                    } else if (typeof data.createdAt === 'string') {
                        createdAtDate = new Date(data.createdAt);
                    } else if (data.createdAt instanceof Date) {
                        createdAtDate = data.createdAt;
                    } else {
                        createdAtDate = new Date();
                    }
                } else {
                    createdAtDate = new Date();
                }
                
                orders.push({
                    id: docSnap.id,
                    ...data,
                    total: Number(data.total) || 0,
                    createdAt: createdAtDate,
                    status: data.status || 'pending',
                    paymentStatus: data.paymentStatus || 'unpaid',
                    paymentMethod: data.paymentMethod || 'cod',
                    userName: data.userName || 'Kh√¥ng c√≥ t√™n',
                    userEmail: data.userEmail || 'N/A',
                    userPhone: data.userPhone || 'N/A',
                    userAddress: data.userAddress || 'N/A',
                    items: data.items || [],
                    note: data.note || '',
                    isStatsUpdated: data.isStatsUpdated || false // Th√™m c·ªù ƒë√£ c·∫≠p nh·∫≠t th·ªëng k√™
                });
            });

            updateStats();
            applyFiltersAndSort();
            renderOrders();
            renderPagination();
            
        } catch (error) {
            console.error("L·ªói t·∫£i ƒë∆°n h√†ng:", error);
            showError("L·ªói t·∫£i ƒë∆°n h√†ng: " + error.message);
            
            const tbody = document.getElementById('orders-list');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #ef4444;">
                        <p>L·ªói k·∫øt n·ªëi Firebase: ${error.message}</p>
                        <p>Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet</p>
                        <button onclick="location.reload()" style="margin-top: 10px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;">Th·ª≠ l·∫°i</button>
                    </td>
                </tr>
            `;
        } finally {
            showLoading(false);
        }
    }

    function updateStats() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const todayOrders = orders.filter(order => {
            const orderDate = new Date(order.createdAt);
            orderDate.setHours(0, 0, 0, 0);
            return orderDate.getTime() === today.getTime();
        });
        
        const pendingOrders = orders.filter(order => order.status === 'pending');
        
        document.getElementById('total-orders').textContent = orders.length;
        document.getElementById('pending-orders').textContent = pendingOrders.length;
        document.getElementById('today-orders').textContent = todayOrders.length;
    }

    function applyFiltersAndSort() {
        filteredOrders = [...orders];

        // Apply date filter
        if (currentFilters.startDate) {
            const startDate = new Date(currentFilters.startDate);
            startDate.setHours(0, 0, 0, 0);
            filteredOrders = filteredOrders.filter(order => {
                const orderDate = new Date(order.createdAt);
                orderDate.setHours(0, 0, 0, 0);
                return orderDate >= startDate;
            });
        }

        if (currentFilters.endDate) {
            const endDate = new Date(currentFilters.endDate);
            endDate.setHours(23, 59, 59, 999);
            filteredOrders = filteredOrders.filter(order => {
                const orderDate = new Date(order.createdAt);
                return orderDate <= endDate;
            });
        }

        // Apply status filter
        if (currentFilters.status) {
            filteredOrders = filteredOrders.filter(order => order.status === currentFilters.status);
        }

        // Apply payment filter
        if (currentFilters.payment) {
            filteredOrders = filteredOrders.filter(order => order.paymentStatus === currentFilters.payment);
        }

        // Apply search filter
        if (currentFilters.search) {
            const searchTerm = currentFilters.search.toLowerCase();
            filteredOrders = filteredOrders.filter(order => 
                order.id.toLowerCase().includes(searchTerm) ||
                (order.userName && order.userName.toLowerCase().includes(searchTerm)) ||
                (order.userEmail && order.userEmail.toLowerCase().includes(searchTerm)) ||
                (order.userPhone && order.userPhone.toLowerCase().includes(searchTerm))
            );
        }

        applySorting();
        updateFilterTags();

        totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
        if (currentPage > totalPages) currentPage = 1;
        
        document.getElementById('showing-orders').textContent = filteredOrders.length;
    }

    function applySorting() {
        switch (currentSort) {
            case 'created_desc':
                filteredOrders.sort((a, b) => b.createdAt - a.createdAt);
                break;
            case 'created_asc':
                filteredOrders.sort((a, b) => a.createdAt - b.createdAt);
                break;
            case 'total_desc':
                filteredOrders.sort((a, b) => (b.total || 0) - (a.total || 0));
                break;
            case 'total_asc':
                filteredOrders.sort((a, b) => (a.total || 0) - (b.total || 0));
                break;
        }
    }

    function updateFilterTags() {
        const tagsContainer = document.getElementById('filter-tags');
        tagsContainer.innerHTML = '';
        
        const tags = [];
        
        if (currentFilters.startDate) {
            tags.push({
                text: `T·ª´: ${formatDate(new Date(currentFilters.startDate))}`,
                type: 'startDate'
            });
        }
        
        if (currentFilters.endDate) {
            tags.push({
                text: `ƒê·∫øn: ${formatDate(new Date(currentFilters.endDate))}`,
                type: 'endDate'
            });
        }
        
        if (currentFilters.status) {
            tags.push({
                text: `Tr·∫°ng th√°i: ${getStatusText(currentFilters.status)}`,
                type: 'status'
            });
        }
        
        if (currentFilters.payment) {
            tags.push({
                text: `Thanh to√°n: ${currentFilters.payment === 'paid' ? 'ƒê√£ thanh to√°n' : 'Ch∆∞a thanh to√°n'}`,
                type: 'payment'
            });
        }
        
        if (currentFilters.search) {
            tags.push({
                text: `T√¨m: "${currentFilters.search}"`,
                type: 'search'
            });
        }
        
        if (tags.length > 0) {
            tags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'filter-tag';
                tagElement.innerHTML = `
                    ${tag.text}
                    <span class="remove" onclick="removeFilter('${tag.type}')">&times;</span>
                `;
                tagsContainer.appendChild(tagElement);
            });
            
            const clearAll = document.createElement('a');
            clearAll.href = '#';
            clearAll.style.fontSize = '1.2rem';
            clearAll.style.color = 'var(--primary)';
            clearAll.style.textDecoration = 'none';
            clearAll.textContent = 'X√≥a t·∫•t c·∫£';
            clearAll.onclick = (e) => {
                e.preventDefault();
                clearAllFilters();
            };
            tagsContainer.appendChild(clearAll);
        }
    }

    // ========== RENDER ORDERS ==========
    function renderOrders() {
        const tbody = document.getElementById('orders-list');
        
        if (filteredOrders.length === 0) {
            tbody.innerHTML = '';
            document.getElementById('empty-state').style.display = 'block';
            return;
        }

        document.getElementById('empty-state').style.display = 'none';

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const ordersToShow = filteredOrders.slice(startIndex, endIndex);

        tbody.innerHTML = ordersToShow.map(order => `
            <tr class="order-row" data-id="${order.id}" onclick="showOrderDetails('${order.id}')">
                <td><strong>${order.id}</strong></td>
                <td>${formatDateTime(order.createdAt)}</td>
                <td>
                    <div class="customer-info">
                        <span class="customer-name">${order.userName || 'Kh√¥ng c√≥ t√™n'}</span>
                        <span class="customer-email" style="font-size: 1.2rem; color: var(--gray-500);">${order.userEmail || ''}</span>
                    </div>
                </td>
                <td>${order.userPhone || 'N/A'}</td>
                <td><strong>${formatPrice(order.total)}</strong></td>
                <td>
                    <span class="status-badge status-${order.status || 'pending'}">
                        ${getStatusText(order.status)}
                    </span>
                </td>
                <td>
                    <span class="payment-status payment-${order.paymentStatus || 'unpaid'}">
                        ${order.paymentStatus === 'paid' ? 'ƒê√£ thanh to√°n' : 'Ch∆∞a thanh to√°n'}
                        ${order.isStatsUpdated ? ' ‚úÖ' : ''}
                    </span>
                </td>
                <td class="action-cell" onclick="event.stopPropagation();">
                    <div class="order-actions">
                        <select class="status-select" onchange="updateOrderStatus('${order.id}', this.value)" 
                                onclick="event.stopPropagation();">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Ch·ªù x·ª≠ l√Ω</option>
                            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="shipping" ${order.status === 'shipping' ? 'selected' : ''}>ƒêang chuy·ªÉn h√†ng</option>
                            <option value="delivering" ${order.status === 'delivering' ? 'selected' : ''}>ƒêang giao h√†ng</option>
                            <option value="success" ${order.status === 'success' ? 'selected' : ''}>Th√†nh c√¥ng</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ƒê√£ hu·ª∑</option>
                        </select>
                        ${order.paymentStatus !== 'paid' && order.status !== 'cancelled' ? `
                            <button class="btn btn-success btn-sm" 
                                    onclick="event.stopPropagation(); confirmPayment('${order.id}')"
                                    title="X√°c nh·∫≠n ƒë√£ thanh to√°n">
                                <span class="material-symbols-outlined" style="font-size: 1.4rem;">payments</span>
                            </button>
                        ` : ''}
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); showOrderDetails('${order.id}')">
                            <span class="material-symbols-outlined" style="font-size: 1.4rem;">visibility</span>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteOrder('${order.id}')">
                            <span class="material-symbols-outlined" style="font-size: 1.4rem;">delete</span>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // ========== UTILITY FUNCTIONS ==========
    function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(price || 0);
    }

    function formatDate(date) {
        if (!date) return 'N/A';
        try {
            return date.toLocaleDateString('vi-VN');
        } catch (error) {
            return 'N/A';
        }
    }

    function formatDateTime(date) {
        if (!date) return 'N/A';
        try {
            const d = new Date(date);
            return d.toLocaleDateString('vi-VN') + ' ' + d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        } catch (error) {
            return 'N/A';
        }
    }

    function getStatusText(status) {
        const statusMap = {
            'pending': 'Ch·ªù x·ª≠ l√Ω',
            'confirmed': 'ƒê√£ x√°c nh·∫≠n',
            'shipping': 'ƒêang chuy·ªÉn h√†ng',
            'delivering': 'ƒêang giao h√†ng',
            'success': 'Th√†nh c√¥ng',
            'cancelled': 'ƒê√£ hu·ª∑'
        };
        return statusMap[status] || status || 'Ch·ªù x·ª≠ l√Ω';
    }

    function showLoading(show) {
        document.getElementById('loading-state').style.display = show ? 'block' : 'none';
    }

    function showNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        `;
        notification.innerHTML = `
            <span class="material-symbols-outlined">check_circle</span>
            ${message}
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        `;
        errorDiv.innerHTML = `
            <span class="material-symbols-outlined">error</span>
            ${message}
        `;
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 3000);
    }

    // ========== PAGINATION ==========
    function renderPagination() {
        document.getElementById('page-info').textContent = `Trang ${currentPage}/${totalPages}`;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages;
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
        // Date filters
        document.getElementById('start-date').addEventListener('change', (e) => {
            currentFilters.startDate = e.target.value;
            currentPage = 1;
            applyFiltersAndSort();
            renderOrders();
            renderPagination();
        });

        document.getElementById('end-date').addEventListener('change', (e) => {
            currentFilters.endDate = e.target.value;
            currentPage = 1;
            applyFiltersAndSort();
            renderOrders();
            renderPagination();
        });

        // Status filter
        document.getElementById('status-filter').addEventListener('change', (e) => {
            currentFilters.status = e.target.value;
            currentPage = 1;
            applyFiltersAndSort();
            renderOrders();
            renderPagination();
        });

        // Payment filter
        document.getElementById('payment-filter').addEventListener('change', (e) => {
            currentFilters.payment = e.target.value;
            currentPage = 1;
            applyFiltersAndSort();
            renderOrders();
            renderPagination();
        });

        // Sort
        document.getElementById('sort-by').addEventListener('change', (e) => {
            currentSort = e.target.value;
            applyFiltersAndSort();
            renderOrders();
        });

        // Search
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });

        // Close details modal
        document.getElementById('close-details').addEventListener('click', closeOrderDetails);
        document.getElementById('order-details-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('order-details-modal')) {
                closeOrderDetails();
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                try {
                    await signOut(auth);
                    window.location.href = '../a1b2c3-secret.html';
                } catch (error) {
                    alert("L·ªói ƒëƒÉng xu·∫•t: " + error.message);
                }
            }
        });
    }

    // ========== GLOBAL WINDOW FUNCTIONS ==========
    window.removeFilter = function(type) {
        switch (type) {
            case 'startDate':
                document.getElementById('start-date').value = '';
                currentFilters.startDate = '';
                break;
            case 'endDate':
                document.getElementById('end-date').value = '';
                currentFilters.endDate = '';
                break;
            case 'status':
                document.getElementById('status-filter').value = '';
                currentFilters.status = '';
                break;
            case 'payment':
                document.getElementById('payment-filter').value = '';
                currentFilters.payment = '';
                break;
            case 'search':
                document.getElementById('search-input').value = '';
                currentFilters.search = '';
                break;
        }
        currentPage = 1;
        applyFiltersAndSort();
        renderOrders();
        renderPagination();
    };

    window.clearAllFilters = function() {
        document.getElementById('start-date').value = '';
        document.getElementById('end-date').value = '';
        document.getElementById('status-filter').value = '';
        document.getElementById('payment-filter').value = '';
        document.getElementById('search-input').value = '';
        document.getElementById('sort-by').value = 'created_desc';
        
        currentFilters = {
            startDate: '',
            endDate: '',
            status: '',
            payment: '',
            search: ''
        };
        currentSort = 'created_desc';
        currentPage = 1;
        
        applyFiltersAndSort();
        renderOrders();
        renderPagination();
    };

    window.applyFilters = function() {
        currentFilters.search = document.getElementById('search-input').value;
        currentPage = 1;
        applyFiltersAndSort();
        renderOrders();
        renderPagination();
    };

    window.showOrderDetails = function(orderId) {
        const order = orders.find(o => o.id === orderId);
        if (!order) return;
        
        const modal = document.getElementById('order-details-modal');
        const body = modal.querySelector('.details-body');
        
        body.innerHTML = `
            <div class="details-section">
                <h3 class="section-title">
                    <span class="material-symbols-outlined">info</span>
                    Th√¥ng tin ƒë∆°n h√†ng
                </h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                    <div>
                        <p><strong>M√£ ƒë∆°n h√†ng:</strong> ${order.id}</p>
                        <p><strong>Ng√†y ƒë·∫∑t:</strong> ${formatDateTime(order.createdAt)}</p>
                        <p><strong>Tr·∫°ng th√°i:</strong> 
                            <span class="status-badge status-${order.status}" style="margin-left: 0.5rem;">
                                ${getStatusText(order.status)}
                            </span>
                        </p>
                        <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${order.paymentMethod === 'cod' ? 'COD (Thanh to√°n khi nh·∫≠n h√†ng)' : 'Chuy·ªÉn kho·∫£n'}</p>
                        <p><strong>T√¨nh tr·∫°ng thanh to√°n:</strong> 
                            <span class="payment-status payment-${order.paymentStatus}" style="margin-left: 0.5rem;">
                                ${order.paymentStatus === 'paid' ? 'ƒê√£ thanh to√°n' : 'Ch∆∞a thanh to√°n'}
                                ${order.isStatsUpdated ? ' (ƒê√£ c·∫≠p nh·∫≠t th·ªëng k√™)' : ''}
                            </span>
                        </p>
                    </div>
                    <div>
                        <p><strong>T·ªïng ti·ªÅn:</strong> <span style="font-size: 1.8rem; color: #e53935; font-weight: bold;">${formatPrice(order.total)}</span></p>
                        <p><strong>Ghi ch√∫:</strong> ${order.note || 'Kh√¥ng c√≥ ghi ch√∫'}</p>
                    </div>
                </div>
            </div>
            
            <div class="details-section">
                <h3 class="section-title">
                    <span class="material-symbols-outlined">person</span>
                    Th√¥ng tin kh√°ch h√†ng
                </h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                    <div>
                        <p><strong>H·ªç t√™n:</strong> ${order.userName || 'N/A'}</p>
                        <p><strong>Email:</strong> ${order.userEmail || 'N/A'}</p>
                        <p><strong>ƒêi·ªán tho·∫°i:</strong> ${order.userPhone || 'N/A'}</p>
                    </div>
                    <div>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${order.userAddress || 'N/A'}</p>
                        <p><strong>User ID:</strong> ${order.userId || 'N/A'}</p>
                    </div>
                </div>
            </div>
            
            <div class="details-section">
                <h3 class="section-title">
                    <span class="material-symbols-outlined">shopping_cart</span>
                    S·∫£n ph·∫©m ƒë√£ ƒë·∫∑t
                </h3>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>S·∫£n ph·∫©m</th>
                            <th>Gi√°</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${order.items && order.items.length > 0 ? order.items.map(item => `
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <img src="${item.image || 'https://via.placeholder.com/60'}" 
                                             alt="${item.name}" 
                                             class="item-image"
                                             onerror="this.src='https://via.placeholder.com/60?text=No+Image'">
                                        <div>
                                            <strong>${item.name}</strong>
                                            <div style="font-size: 1.2rem; color: var(--gray-600);">
                                                ${item.color ? `<span>M√†u: ${item.color}</span>` : ''}
                                                ${item.storage ? `<span> | Dung l∆∞·ª£ng: ${item.storage}</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>${formatPrice(item.price)}</td>
                                <td>${item.quantity}</td>
                                <td><strong>${formatPrice(item.price * item.quantity)}</strong></td>
                            </tr>
                        `).join('') : '<tr><td colspan="4" style="text-align: center;">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>'}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: right; font-weight: bold;">T·ªïng c·ªông:</td>
                            <td style="font-weight: bold; font-size: 1.6rem; color: #e53935;">${formatPrice(order.total)}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="details-section">
                <h3 class="section-title">
                    <span class="material-symbols-outlined">payments</span>
                    Qu·∫£n l√Ω thanh to√°n
                </h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div style="flex: 1;">
                        <p><strong>Tr·∫°ng th√°i thanh to√°n:</strong></p>
                        <span class="payment-status payment-${order.paymentStatus}" style="font-size: 1.4rem;">
                            ${order.paymentStatus === 'paid' ? '‚úÖ ƒê√£ thanh to√°n' : '‚ùå Ch∆∞a thanh to√°n'}
                            ${order.isStatsUpdated ? ' (ƒê√£ c·∫≠p nh·∫≠t th·ªëng k√™)' : ''}
                        </span>
                    </div>
                    ${order.paymentStatus !== 'paid' && order.status !== 'cancelled' ? `
                        <button class="btn btn-success" onclick="confirmPayment('${order.id}')" style="padding: 10px 20px;">
                            <span class="material-symbols-outlined">check_circle</span>
                            X√°c nh·∫≠n ƒë√£ thanh to√°n
                        </button>
                    ` : ''}
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="closeOrderDetails()">ƒê√≥ng</button>
                <button class="btn btn-primary" onclick="printOrder('${order.id}')">In ƒë∆°n h√†ng</button>
                ${order.status !== 'cancelled' ? `
                    <button class="btn btn-danger" onclick="cancelOrder('${order.id}')">Hu·ª∑ ƒë∆°n h√†ng</button>
                ` : ''}
            </div>
        `;
        
        modal.style.display = 'block';
    };

    window.closeOrderDetails = function() {
        document.getElementById('order-details-modal').style.display = 'none';
    };

    // H√†m chung ƒë·ªÉ c·∫≠p nh·∫≠t th·ªëng k√™ khi thanh to√°n
    async function updateOrderStats(orderId, order) {
        try {
            console.log(`üîÑ C·∫≠p nh·∫≠t th·ªëng k√™ cho ƒë∆°n h√†ng ${orderId}...`);
            
            // 1. C·∫¨P NH·∫¨T TH·ªêNG K√ä NG∆Ø·ªúI D√ôNG
            if (order.userId) {
                try {
                    const userRef = doc(db, "users", order.userId);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        const currentTotalOrders = userData.totalOrders || 0;
                        const currentTotalSpent = userData.totalSpent || 0;
                        
                        // TƒÉng s·ªë ƒë∆°n v√† t·ªïng chi ti√™u
                        await updateDoc(userRef, {
                            totalOrders: currentTotalOrders + 1,
                            totalSpent: currentTotalSpent + (order.total || 0),
                            updatedAt: serverTimestamp()
                        });
                        
                        console.log(`üë§ ƒê√£ c·∫≠p nh·∫≠t user ${order.userId}: 
                            totalOrders t·ª´ ${currentTotalOrders} ‚Üí ${currentTotalOrders + 1}
                            totalSpent t·ª´ ${currentTotalSpent} ‚Üí ${currentTotalSpent + (order.total || 0)}`);
                    } else {
                        console.warn(`Kh√¥ng t√¨m th·∫•y user ${order.userId}`);
                    }
                } catch (userError) {
                    console.error("‚ùå L·ªói c·∫≠p nh·∫≠t user:", userError);
                    throw userError;
                }
            } else {
                console.warn("ƒê∆°n h√†ng kh√¥ng c√≥ userId, kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th·ªëng k√™ user");
            }
            
            // 2. C·∫¨P NH·∫¨T S·∫¢N PH·∫®M (TƒÇNG SOLD, GI·∫¢M STOCK)
            const items = order.items || [];
            for (const item of items) {
                if (item.productId) {
                    try {
                        const productRef = doc(db, "products", item.productId);
                        const productDoc = await getDoc(productRef);
                        
                        if (productDoc.exists()) {
                            const productData = productDoc.data();
                            const currentStock = productData.stock || 0;
                            const currentSold = productData.sold || 0;
                            const quantity = item.quantity || 1;
                            
                            // S·ª≠ d·ª•ng increment ƒë·ªÉ ƒë·∫£m b·∫£o atomic operation
                            await updateDoc(productRef, {
                                stock: Math.max(0, currentStock - quantity),
                                sold: currentSold + quantity,
                                updatedAt: serverTimestamp()
                            });
                            
                            console.log(`üì¶ ƒê√£ c·∫≠p nh·∫≠t s·∫£n ph·∫©m ${item.productId}: 
                                stock t·ª´ ${currentStock} ‚Üí ${Math.max(0, currentStock - quantity)}
                                sold t·ª´ ${currentSold} ‚Üí ${currentSold + quantity}`);
                        }
                    } catch (productError) {
                        console.error("‚ùå L·ªói c·∫≠p nh·∫≠t s·∫£n ph·∫©m:", productError);
                        throw productError;
                    }
                } else {
                    console.warn(`S·∫£n ph·∫©m "${item.name}" kh√¥ng c√≥ productId, kh√¥ng th·ªÉ c·∫≠p nh·∫≠t`);
                }
            }
            
            return true;
        } catch (error) {
            console.error("‚ùå L·ªói c·∫≠p nh·∫≠t th·ªëng k√™:", error);
            throw error;
        }
    }

    window.updateOrderStatus = async function(orderId, newStatus) {
        try {
            const orderRef = doc(db, "orders", orderId);
            const orderDoc = await getDoc(orderRef);
            const order = orderDoc.data();

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
            await updateDoc(orderRef, {
                status: newStatus,
                updatedAt: serverTimestamp()
            });
            
            // LOGIC QUAN TR·ªåNG: 
            // "Th√†nh c√¥ng" (success) ch·ªâ l√† tr·∫°ng th√°i v·∫≠n chuy·ªÉn (ship th√†nh c√¥ng)
            // KH√îNG t·ª± ƒë·ªông c·∫≠p nh·∫≠t th·ªëng k√™ ·ªü ƒë√¢y!
            // Ch·ªâ b·∫•m "X√°c nh·∫≠n thanh to√°n" m·ªõi c·∫≠p nh·∫≠t th·ªëng k√™
            
            // C·∫≠p nh·∫≠t trong m·∫£ng orders local
            const orderIndex = orders.findIndex(o => o.id === orderId);
            if (orderIndex > -1) {
                orders[orderIndex].status = newStatus;
            }
            
            renderOrders();
            updateStats();
            showNotification(`ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh: ${getStatusText(newStatus)}`);
            
        } catch (error) {
            showError("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i: " + error.message);
        }
    };

    window.confirmPayment = async function(orderId) {
        if (!confirm('X√°c nh·∫≠n ƒë∆°n h√†ng n√†y ƒë√£ ƒë∆∞·ª£c thanh to√°n?\n')) return;
        
        try {
            // L·∫•y th√¥ng tin ƒë∆°n h√†ng tr∆∞·ªõc
            const orderRef = doc(db, "orders", orderId);
            const orderSnap = await getDoc(orderRef);
            
            if (!orderSnap.exists()) {
                showError("ƒê∆°n h√†ng kh√¥ng t·ªìn t·∫°i!");
                return;
            }
            
            const order = orderSnap.data();
            
            // Ki·ªÉm tra ƒë√£ thanh to√°n ch∆∞a
            if (order.paymentStatus === 'paid') {
                showError("ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c thanh to√°n tr∆∞·ªõc ƒë√≥!");
                return;
            }
            
            // Ki·ªÉm tra ƒë√£ c·∫≠p nh·∫≠t th·ªëng k√™ ch∆∞a
            if (order.isStatsUpdated) {
                showError("ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th·ªëng k√™ tr∆∞·ªõc ƒë√≥!");
                return;
            }
            
            // 1. C·∫¨P NH·∫¨T TH·ªêNG K√ä - ƒê√¢y l√† b∆∞·ªõc QUAN TR·ªåNG NH·∫§T
            await updateOrderStats(orderId, order);
            
            // 2. C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n v√† ƒë√°nh d·∫•u ƒë√£ c·∫≠p nh·∫≠t th·ªëng k√™
            await updateDoc(orderRef, {
                paymentStatus: 'paid',
                isStatsUpdated: true, // QUAN TR·ªåNG: ƒê√°nh d·∫•u ƒë√£ c·∫≠p nh·∫≠t th·ªëng k√™
                paymentDate: serverTimestamp(),
                updatedAt: serverTimestamp()
            });
            
            // 3. C·∫≠p nh·∫≠t trong m·∫£ng orders local
            const orderIndex = orders.findIndex(o => o.id === orderId);
            if (orderIndex > -1) {
                orders[orderIndex].paymentStatus = 'paid';
                orders[orderIndex].isStatsUpdated = true;
            }
            
            renderOrders();
            updateStats();
            
            // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt v·ªÅ c·∫≠p nh·∫≠t
            const items = order.items || [];
            const totalQuantity = items.reduce((sum, item) => sum + (item.quantity || 1), 0);
            
            showNotification(` ƒê√£ x√°c nh·∫≠n thanh to√°n th√†nh c√¥ng!\n Th·ªëng k√™ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t:\n‚Ä¢ User: +1 ƒë∆°n h√†ng, +${formatPrice(order.total)}\n‚Ä¢ S·∫£n ph·∫©m: ${totalQuantity} s·∫£n ph·∫©m ƒë√£ b√°n`);
            
            closeOrderDetails();
            
        } catch (error) {
            console.error("‚ùå L·ªói x√°c nh·∫≠n thanh to√°n:", error);
            showError("L·ªói x√°c nh·∫≠n thanh to√°n: " + error.message);
        }
    };

    window.deleteOrder = async function(orderId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n h√†ng n√†y?')) return;
        
        try {
            await deleteDoc(doc(db, "orders", orderId));
            
            orders = orders.filter(o => o.id !== orderId);
            applyFiltersAndSort();
            renderOrders();
            updateStats();
            showNotification('ƒê√£ x√≥a ƒë∆°n h√†ng');
            
        } catch (error) {
            showError("L·ªói x√≥a ƒë∆°n h√†ng: " + error.message);
        }
    };

    window.cancelOrder = async function(orderId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën hu·ª∑ ƒë∆°n h√†ng n√†y?')) return;
        
        await window.updateOrderStatus(orderId, 'cancelled');
        window.closeOrderDetails();
    };

    window.prevPage = function() {
        if (currentPage > 1) {
            currentPage--;
            renderOrders();
            renderPagination();
        }
    };

    window.nextPage = function() {
        if (currentPage < totalPages) {
            currentPage++;
            renderOrders();
            renderPagination();
        }
    };

    window.changePerPage = function(value) {
        itemsPerPage = parseInt(value);
        currentPage = 1;
        applyFiltersAndSort();
        renderOrders();
        renderPagination();
    };

    window.refreshOrders = async function() {
        await loadOrders();
        showNotification('ƒê√£ l√†m m·ªõi danh s√°ch ƒë∆°n h√†ng');
    };

    window.printOrders = function() {
        window.print();
    };

    window.printOrder = function(orderId) {
        const order = orders.find(o => o.id === orderId);
        if (!order) return;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>ƒê∆°n h√†ng ${orderId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #333; }
                        .info { margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; }
                        .total { font-weight: bold; font-size: 1.2em; }
                    </style>
                </head>
                <body>
                    <h1>ƒê∆°n h√†ng: ${orderId}</h1>
                    <div class="info">
                        <p><strong>Ng√†y ƒë·∫∑t:</strong> ${formatDateTime(order.createdAt)}</p>
                        <p><strong>Kh√°ch h√†ng:</strong> ${order.userName}</p>
                        <p><strong>ƒêi·ªán tho·∫°i:</strong> ${order.userPhone}</p>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${order.userAddress}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>S·∫£n ph·∫©m</th>
                                <th>ƒê∆°n gi√°</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items ? order.items.map(item => `
                                <tr>
                                    <td>${item.name} ${item.color ? `(${item.color})` : ''} ${item.storage ? `[${item.storage}]` : ''}</td>
                                    <td>${formatPrice(item.price)}</td>
                                    <td>${item.quantity}</td>
                                    <td>${formatPrice(item.price * item.quantity)}</td>
                                </tr>
                            `).join('') : ''}
                        </tbody>
                        <tfoot>
                            <tr class="total">
                                <td colspan="3" style="text-align: right;">T·ªïng c·ªông:</td>
                                <td>${formatPrice(order.total)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    };

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
        
        // ƒê√≥ng menu khi click b√™n ngo√†i tr√™n mobile
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('admin-sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('active') && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });
        
        // Set default dates (last 30 days)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);
        
        const startDateStr = startDate.toISOString().split('T')[0];
        const endDateStr = endDate.toISOString().split('T')[0];
        
        document.getElementById('start-date').value = startDateStr;
        document.getElementById('end-date').value = endDateStr;
        
        currentFilters.startDate = startDateStr;
        currentFilters.endDate = endDateStr;
    });
</script>
</body>
</html>