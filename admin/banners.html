<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"/>
    <title>Quản lý Banner - Store Phone</title>
    <link rel="stylesheet" href="./assets/css/admin.css">
    <link rel="stylesheet" href="./assets/css/banner.css">
</head>
<body>
    <div class="admin-layout">
        <!-- SIDEBAR -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2>STORE PHONE</h2>
                <p>Admin Dashboard</p>
            </div>
            
           <nav class="sidebar-menu">
                <a href="index.html" class="menu-item">
                    <span class="material-symbols-outlined">inventory_2</span>
                    Sản phẩm
                </a>
                <a href="orders.html" class="menu-item">
                    <span class="material-symbols-outlined">shopping_bag</span>
                    Đơn hàng
                </a>
                <a href="chats.html" class="menu-item">
                    <span class="material-symbols-outlined">chat</span>
                    Quản lý Chat
                </a>
                <a href="banners.html" class="menu-item active">
                    <span class="material-symbols-outlined">image</span>
                    Banner
                </a>
                <a href="images.html" class="menu-item">
                    <span class="material-symbols-outlined">photo_library</span>
                    Quản lý ảnh
                </a>
                <a href="users.html" class="menu-item" id="users-menu-link">
                    <span class="material-symbols-outlined">group</span>
                    Người dùng
                </a>
                <a href="analytics.html" class="menu-item">
                    <span class="material-symbols-outlined">analytics</span>
                    Thống kê
                </a>
                <a href="../index.html" class="menu-item">
                    <span class="material-symbols-outlined">home</span>
                    Về trang chủ
                </a>
                <a href="#" class="menu-item" id="logout-btn">
                    <span class="material-symbols-outlined">logout</span>
                    Đăng xuất
                </a>
            </nav>
            
            <div class="user-info">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="user-name" style="font-size: 1.4rem; font-weight: 500;"></span>
                            <span id="user-role-badge" class="role-badge role-admin"></span>
                        </div>
                        <div id="user-email" style="font-size: 1.2rem; color: var(--gray-400);"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="admin-main">
            <!-- TOP BAR -->
            <header class="admin-topbar">
                <h1>Quản lý Banner</h1>
                <p style="font-size: 1.4rem; color: var(--gray-500); margin-top: 0.5rem;">
                    Quản lý banner hiển thị trên trang chủ
                </p>
            </header>

            <!-- CONTENT AREA -->
            <div class="admin-content">
                <!-- THÊM BANNER MỚI -->
                <div class="add-box" style="background: var(--gray-100); padding: 2rem; border-radius: var(--radius); margin-bottom: 3rem;">
                    <h3 style="font-size: 1.8rem; margin-bottom: 1.5rem; color: var(--dark);">
                        <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 0.5rem;">add_photo_alternate</span>
                        Thêm banner mới
                    </h3>
                    
                    <div class="url-input-group" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                        <input type="text" 
                               id="banner-url" 
                               placeholder="Dán link ảnh hoặc chọn từ thư viện"
                               style="flex: 1; padding: 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius); font-size: 1.4rem;">
                        <button id="select-image-btn" class="btn-secondary" style="padding: 1rem 1.5rem; cursor: pointer;">
                            <span class="material-symbols-outlined">photo_library</span>
                            Chọn ảnh
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <button id="add-banner" class="btn btn-add" style="padding: 1rem 2rem;">
                            <span class="material-symbols-outlined">add</span>
                            Thêm banner
                        </button>
                        <div style="font-size: 1.3rem; color: var(--gray-500);">
                            <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.6rem; color: var(--warning);">info</span>
                            Trang chủ chỉ hiển thị banner có trạng thái "Đang bật"
                        </div>
                    </div>
                    
                    <div class="status-message" id="status-message" style="margin-top: 1rem; font-size: 1.4rem;"></div>
                </div>

                <!-- DANH SÁCH BANNER -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h3 style="font-size: 1.8rem; color: var(--dark);">
                            <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 0.5rem;">list</span>
                            Danh sách banner
                        </h3>
                        <div style="font-size: 1.3rem; color: var(--gray-500);">
                            <span id="banner-count">0</span> banner
                        </div>
                    </div>

                    <div id="banner-list" class="banner-list"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL CHỌN ẢNH -->
    <div id="image-select-modal" class="image-select-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    ">
        <div class="image-select-content" style="
            background: white;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            border-radius: var(--radius-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        ">
            <div class="image-select-header" style="
                padding: 2rem;
                background: var(--gray-100);
                border-bottom: 1px solid var(--gray-300);
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <h3 style="margin: 0; font-size: 1.8rem; color: var(--dark);">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">photo_library</span>
                    Chọn ảnh từ thư viện
                </h3>
                <button onclick="closeImageModal()" style="
                    background: none;
                    border: none;
                    font-size: 3rem;
                    cursor: pointer;
                    color: var(--gray-500);
                    line-height: 1;
                    padding: 0;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">&times;</button>
            </div>
            
            <div id="modal-image-grid" class="image-grid-select" style="
                flex: 1;
                overflow-y: auto;
                padding: 2rem;
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1.5rem;
            "></div>
            
            <div class="image-select-footer" style="
                padding: 1.5rem 2rem;
                background: var(--gray-100);
                border-top: 1px solid var(--gray-300);
                display: flex;
                justify-content: flex-end;
                gap: 1rem;
            ">
                <button onclick="closeImageModal()" class="btn-secondary" style="padding: 0.8rem 1.5rem;">Hủy</button>
                <button onclick="confirmImageSelection()" class="btn-primary" style="padding: 0.8rem 1.5rem;">Chọn ảnh</button>
            </div>
        </div>
    </div>

<script type="module">
    // ========== FIREBASE CONFIG ==========
    import { firebaseConfig } from "../assets/js/API.js";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        getDocs, 
        query,
        where,
        doc,
        deleteDoc,
        addDoc,
        updateDoc,
        serverTimestamp,
        orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ========== GLOBAL VARIABLES ==========
    let banners = [];
    let allImages = [];
    let selectedImageUrl = '';
    let currentUserRole = '';

    // ========== AUTH CHECK VÀ PHÂN QUYỀN ==========
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = '../a1b2c3-secret.html';
            return;
        }
        
        try {
            const adminsRef = collection(db, "admins");
            const q = query(adminsRef, where("email", "==", user.email));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                await signOut(auth);
                alert("❌ Bạn không có quyền truy cập Admin Panel!");
                window.location.href = '../a1b2c3-secret.html';
                return;
            }
            
            const adminData = snapshot.docs[0].data();
            currentUserRole = adminData.role || 'admin';
            
            document.getElementById('user-name').textContent = adminData.name || user.displayName || 'Admin';
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-avatar').textContent = 
                (adminData.name?.charAt(0) || user.email.charAt(0)).toUpperCase();
            
            const roleBadge = document.getElementById('user-role-badge');
            if (currentUserRole === 'super_admin') {
                roleBadge.textContent = 'Super Admin';
                roleBadge.className = 'role-badge role-super_admin';
            } else if (currentUserRole === 'admin') {
                roleBadge.textContent = 'Admin';
                roleBadge.className = 'role-badge role-admin';
            } else if (currentUserRole === 'staff') {
                roleBadge.textContent = 'Nhân viên';
                roleBadge.className = 'role-badge role-staff';
            }
            
            setupMenuPermissions();
            await loadBanners();
            await preloadImages();
            
        } catch (error) {
            window.location.href = '../a1b2c3-secret.html';
        }
    });

    // ========== KIỂM TRA QUYỀN TRUY CẬP MENU ==========
    function setupMenuPermissions() {
        const usersMenuLink = document.getElementById('users-menu-link');
        
        if (usersMenuLink) {
            usersMenuLink.addEventListener('click', function(e) {
                if (currentUserRole === 'staff') {
                    e.preventDefault();
                    alert("❌ Chỉ quản trị viên mới được truy cập trang Quản lý Người dùng!");
                    return false;
                }
                return true;
            });
        }
    }

    // ========== PRELOAD IMAGES FROM FIREBASE ==========
    async function preloadImages() {
        try {
            const imagesRef = collection(db, "images");
            const q = query(imagesRef, orderBy("uploadedAt", "desc"));
            const snapshot = await getDocs(q);
            
            allImages = [];
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                allImages.push({
                    id: docSnap.id,
                    url: data.url,
                    thumb: data.thumb || data.url,
                    name: data.name || 'Ảnh không tên',
                    uploadedAt: data.uploadedAt?.toDate?.() || new Date()
                });
            });
            
            localStorage.setItem('store_images_cache', JSON.stringify(allImages));
            
        } catch (error) {
            const cache = localStorage.getItem('store_images_cache');
            if (cache) {
                allImages = JSON.parse(cache);
            } else {
                const oldImages = JSON.parse(localStorage.getItem('store_images') || '[]');
                allImages = oldImages;
            }
        }
    }

    // ========== BANNER MANAGEMENT FUNCTIONS ==========
    async function loadBanners() {
        try {
            const list = document.getElementById("banner-list");
            list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--gray-500);">Đang tải banner...</div>';
            
            const bannersRef = collection(db, "banners");
            const snapshot = await getDocs(bannersRef);
            
            banners = [];
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                banners.push({
                    id: docSnap.id,
                    ...data,
                    enabled: data.enabled !== false,
                    order: data.order || 0
                });
            });

            updateBannerCount();
            renderBanners();
            showStatus(`Đã tải ${banners.length} banner`, 'success');
            
        } catch (error) {
            showStatus("Lỗi tải banners từ Firebase", 'error');
            
            banners = JSON.parse(localStorage.getItem("banners")) || [];
            updateBannerCount();
            renderBanners();
            showStatus(`Đang dùng dữ liệu local (${banners.length} banner)`, 'error');
        }
    }

    function updateBannerCount() {
        document.getElementById('banner-count').textContent = banners.length;
    }

    function renderBanners() {
        const list = document.getElementById("banner-list");
        
        if (banners.length === 0) {
            list.innerHTML = `
                <div style="text-align:center;padding:60px;color:var(--gray-500);">
                    <span class="material-symbols-outlined" style="font-size:6rem;margin-bottom:1.5rem;color:var(--gray-300);">
                        image
                    </span>
                    <h3 style="font-size:1.8rem;margin-bottom:1rem;">Chưa có banner nào</h3>
                    <p style="font-size:1.4rem;">Thêm banner đầu tiên để hiển thị trên trang chủ!</p>
                </div>
            `;
            return;
        }

        banners.sort((a, b) => (a.order || 0) - (b.order || 0));

        list.innerHTML = banners.map((b, i) => `
            <div class="banner-item" data-id="${b.id}">
                <img src="${b.url}" alt="banner" onerror="this.src='https://via.placeholder.com/200x100?text=Ảnh+lỗi'">
                <div>
                    <div class="status-badge ${b.enabled ? "on" : "off"}">
                        ${b.enabled ? "ĐANG BẬT" : "ĐANG TẮT"}
                    </div>
                    <p style="font-size:1.4rem;margin-top:8px;color:var(--gray-600);word-break:break-all;">
                        ${b.url.substring(0, 80)}${b.url.length > 80 ? '...' : ''}
                    </p>
                    <p style="font-size:1.2rem;margin-top:4px;color:var(--gray-500);">
                        Thứ tự: ${i + 1}
                    </p>
                </div>
                <div class="banner-actions">
                    <button onclick="toggleBanner('${b.id}', ${i})" class="btn-edit" title="${b.enabled ? 'Tắt banner' : 'Bật banner'}">
                        <span class="material-symbols-outlined" style="font-size:1.6rem;">
                            ${b.enabled ? 'toggle_on' : 'toggle_off'}
                        </span>
                        ${b.enabled ? "Tắt" : "Bật"}
                    </button>
                    <button onclick="moveBannerUp(${i})" title="Di chuyển lên">
                        <span class="material-symbols-outlined" style="font-size:1.6rem;">arrow_upward</span>
                    </button>
                    <button onclick="moveBannerDown(${i})" title="Di chuyển xuống">
                        <span class="material-symbols-outlined" style="font-size:1.6rem;">arrow_downward</span>
                    </button>
                    <button onclick="removeBanner('${b.id}', ${i})" class="btn-delete" title="Xóa banner">
                        <span class="material-symbols-outlined" style="font-size:1.6rem;">delete</span>
                        Xóa
                    </button>
                </div>
            </div>
        `).join('');
    }

    // ========== BANNER ACTIONS ==========
    window.toggleBanner = async function(id, index) {
        try {
            banners[index].enabled = !banners[index].enabled;
            await updateDoc(doc(db, "banners", id), {
                enabled: banners[index].enabled,
                updatedAt: serverTimestamp()
            });
            renderBanners();
            showStatus(`Đã ${banners[index].enabled ? 'bật' : 'tắt'} banner`, 'success');
        } catch (error) {
            showStatus("Lỗi cập nhật banner: " + error.message, 'error');
            banners[index].enabled = !banners[index].enabled;
            localStorage.setItem("banners", JSON.stringify(banners));
            renderBanners();
        }
    };

    window.moveBannerUp = async function(index) {
        if (index === 0) return;
        
        try {
            [banners[index-1], banners[index]] = [banners[index], banners[index-1]];
            
            const updatePromises = [];
            banners.forEach((b, i) => {
                b.order = i;
                updatePromises.push(updateDoc(doc(db, "banners", b.id), {
                    order: i,
                    updatedAt: serverTimestamp()
                }));
            });
            
            await Promise.all(updatePromises);
            renderBanners();
            showStatus('Đã di chuyển banner lên', 'success');
        } catch (error) {
            showStatus("Lỗi sắp xếp banner: " + error.message, 'error');
            localStorage.setItem("banners", JSON.stringify(banners));
            renderBanners();
        }
    };

    window.moveBannerDown = async function(index) {
        if (index === banners.length - 1) return;
        
        try {
            [banners[index+1], banners[index]] = [banners[index], banners[index+1]];
            
            const updatePromises = [];
            banners.forEach((b, i) => {
                b.order = i;
                updatePromises.push(updateDoc(doc(db, "banners", b.id), {
                    order: i,
                    updatedAt: serverTimestamp()
                }));
            });
            
            await Promise.all(updatePromises);
            renderBanners();
            showStatus('Đã di chuyển banner xuống', 'success');
        } catch (error) {
            showStatus("Lỗi sắp xếp banner: " + error.message, 'error');
            localStorage.setItem("banners", JSON.stringify(banners));
            renderBanners();
        }
    };

    window.removeBanner = async function(id, index) {
        if (!confirm("Bạn có chắc muốn xóa banner này?")) return;
        
        try {
            await deleteDoc(doc(db, "banners", id));
            banners.splice(index, 1);
            
            const updatePromises = [];
            banners.forEach((b, i) => {
                b.order = i;
                updatePromises.push(updateDoc(doc(db, "banners", b.id), {
                    order: i,
                    updatedAt: serverTimestamp()
                }));
            });
            
            if (updatePromises.length > 0) {
                await Promise.all(updatePromises);
            }
            
            updateBannerCount();
            renderBanners();
            showStatus('Đã xóa banner', 'success');
        } catch (error) {
            showStatus("Lỗi xóa banner: " + error.message, 'error');
            banners.splice(index, 1);
            updateBannerCount();
            localStorage.setItem("banners", JSON.stringify(banners));
            renderBanners();
        }
    };

    // ========== THÊM BANNER MỚI ==========
    document.getElementById("select-image-btn").addEventListener("click", () => {
        openImageModal();
    });

    document.getElementById("add-banner").addEventListener("click", async () => {
        const url = document.getElementById("banner-url").value.trim();
        if (!url) {
            showStatus('Vui lòng nhập link ảnh hoặc chọn từ thư viện', 'error');
            return;
        }
        
        if (!url.startsWith('http')) {
            showStatus('Link ảnh không hợp lệ! Phải bắt đầu bằng http:// hoặc https://', 'error');
            return;
        }

        try {
            const newBanner = {
                url: url,
                enabled: true,
                order: banners.length,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };
            
            showStatus('Đang thêm banner...', '');
            const docRef = await addDoc(collection(db, "banners"), newBanner);
            newBanner.id = docRef.id;
            banners.push(newBanner);
            
            document.getElementById("banner-url").value = "";
            selectedImageUrl = "";
            updateBannerCount();
            renderBanners();
            showStatus('✅ Đã thêm banner thành công!', 'success');
            
            setTimeout(() => {
                showStatus('');
            }, 3000);
            
        } catch (error) {
            showStatus("Lỗi thêm banner: " + error.message, 'error');
            banners.push({
                url: url,
                enabled: true,
                order: banners.length
            });
            localStorage.setItem("banners", JSON.stringify(banners));
            document.getElementById("banner-url").value = "";
            selectedImageUrl = "";
            updateBannerCount();
            renderBanners();
        }
    });

    // ========== IMAGE SELECTION MODAL ==========
    async function openImageModal() {
        await preloadImages();
        document.getElementById('image-select-modal').style.display = 'flex';
        loadModalImages();
    }
    
    function loadModalImages() {
        const grid = document.getElementById('modal-image-grid');
        
        if (allImages.length === 0) {
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: var(--gray-500);">
                    <span class="material-symbols-outlined" style="font-size: 6rem; margin-bottom: 1.5rem; color: var(--gray-300);">photo_library</span>
                    <p style="font-size: 1.6rem; margin-bottom: 0.5rem;">Thư viện ảnh trống</p>
                    <p style="font-size: 1.4rem;">Vào trang Quản lý ảnh để upload ảnh</p>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = allImages.map((img, index) => `
            <div class="image-select-item" 
                 onclick="selectSingleImage('${img.url}')"
                 style="border-color: ${selectedImageUrl === img.url ? 'var(--success)' : 'var(--gray-200)'};">
                <img src="${img.thumb || img.url}" 
                     alt="${img.name}" 
                     style="width: 100%; height: 120px; object-fit: cover;"
                     onerror="this.src='https://via.placeholder.com/150x120?text=Ảnh'">
                <div style="padding: 1rem; font-size: 1.3rem; color: var(--gray-600); text-align: center;">
                    ${(img.name || 'Ảnh').substring(0, 15)}${(img.name || 'Ảnh').length > 15 ? '...' : ''}
                </div>
            </div>
        `).join('');
    }
    
    window.selectSingleImage = function(url) {
        selectedImageUrl = url;
        loadModalImages();
    };
    
    window.confirmImageSelection = function() {
        if (selectedImageUrl) {
            document.getElementById('banner-url').value = selectedImageUrl;
        }
        closeImageModal();
    };
    
    window.closeImageModal = function() {
        document.getElementById('image-select-modal').style.display = 'none';
        selectedImageUrl = '';
    };

    function showStatus(message, type = '') {
        const statusEl = document.getElementById('status-message');
        statusEl.textContent = message;
        statusEl.className = 'status-message ' + type;
    }

    // ========== LOGOUT ==========
    document.getElementById('logout-btn').addEventListener('click', async () => {
        if (confirm('Bạn có chắc muốn đăng xuất?')) {
            try {
                await signOut(auth);
                window.location.href = '../a1b2c3-secret.html';
            } catch (error) {
                alert("Lỗi đăng xuất: " + error.message);
            }
        }
    });
</script>
</body>
</html>