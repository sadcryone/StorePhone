<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X√°c th·ª±c Email - Store Phone</title>
  <link rel="stylesheet" href="./assets/css/login-register.css">
  <style>
    .verification-steps {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .step {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .step:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .step-number {
      background: #3b82f6;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .step-content {
      flex: 1;
    }
    
    .step-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #1e293b;
    }
    
    .step-description {
      color: #64748b;
      font-size: 1.3rem;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-box">
      <div class="logo">
        <div class="material-symbols-outlined logo-icon">mark_email_read</div>
        <h1>X√°c th·ª±c Email</h1>
      </div>
      
      <div id="verificationStatus" class="message">
        <p>ƒêang ki·ªÉm tra tr·∫°ng th√°i x√°c th·ª±c...</p>
      </div>
      
      <div class="verification-steps" id="stepsContainer" style="display: none;">
        <div class="step">
          <div class="step-number">1</div>
          <div class="step-content">
            <div class="step-title">Ki·ªÉm tra email</div>
            <div class="step-description">M·ªü email ch√∫ng t√¥i ƒë√£ g·ª≠i ƒë·∫øn b·∫°n</div>
          </div>
        </div>
        <div class="step">
          <div class="step-number">2</div>
          <div class="step-content">
            <div class="step-title">Click li√™n k·∫øt x√°c th·ª±c</div>
            <div class="step-description">Nh·∫•p v√†o n√∫t ho·∫∑c li√™n k·∫øt "X√°c th·ª±c Email"</div>
          </div>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-content">
            <div class="step-title">T√†i kho·∫£n ƒë√£ s·∫µn s√†ng</div>
            <div class="step-description">Quay l·∫°i ƒëƒÉng nh·∫≠p v√† b·∫Øt ƒë·∫ßu mua s·∫Øm</div>
          </div>
        </div>
      </div>
      
      <button id="resendBtn" class="auth-btn" style="margin-top: 20px; display: none;">
        <span class="material-symbols-outlined">send</span>
        G·ª≠i l·∫°i email x√°c th·ª±c
      </button>
      
      <div class="auth-footer" style="margin-top: 20px;">
        <a href="login.html" class="auth-links">
          <span class="material-symbols-outlined">login</span>
          ƒêƒÉng nh·∫≠p
        </a>
        <div style="margin-top: 10px;">
          <a href="index.html" class="auth-links">
            <span class="material-symbols-outlined">home</span>
            V·ªÅ trang ch·ªß
          </a>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged,
      sendEmailVerification,
      applyActionCode,
      checkActionCode
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      updateDoc,
      getDoc,
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0ua4VVMCYnJa2ndQ2MMgDYPNdCEfoxwY",
      authDomain: "products-a39df.firebaseapp.com",
      projectId: "products-a39df",
      storageBucket: "products-a39df.firebasestorage.app",
      messagingSenderId: "708345988066",
      appId: "1:708345988066:web:b8011a4859285450162fbb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const statusDiv = document.getElementById('verificationStatus');
    const resendBtn = document.getElementById('resendBtn');
    const stepsContainer = document.getElementById('stepsContainer');
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const oobCode = urlParams.get('oobCode');

    // üî• H√ÄM T√åM USER TRONG FIRESTORE B·∫∞NG EMAIL
    async function findUserByEmail(email) {
      try {
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("email", "==", email.toLowerCase()));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          const userDoc = querySnapshot.docs[0];
          return { 
            id: userDoc.id, 
            ...userDoc.data() 
          };
        }
        return null;
      } catch (error) {
        console.error("Error finding user by email:", error);
        return null;
      }
    }

    // üî• H√ÄM C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI USER TRONG FIRESTORE
    async function updateUserStatusInFirestore(userId, status) {
      try {
        const userRef = doc(db, "users", userId);
        const userDoc = await getDoc(userRef);
        
        if (userDoc.exists()) {
          await updateDoc(userRef, {
            status: status,
            emailVerified: true,
            updatedAt: new Date()
          });
          console.log(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t user ${userId} th√†nh ${status}`);
          return true;
        } else {
          console.warn("User kh√¥ng t·ªìn t·∫°i trong Firestore:", userId);
          return false;
        }
      } catch (error) {
        console.error("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i trong Firestore:", error);
        return false;
      }
    }

    // Ki·ªÉm tra n·∫øu user click link t·ª´ email
    if (mode === 'verifyEmail' && oobCode) {
      try {
        statusDiv.innerHTML = `
          <div style="text-align: center;">
            <div class="spinner" style="margin: 0 auto 15px;"></div>
            <p>ƒêang x√°c th·ª±c email...</p>
          </div>
        `;
        
        // üî• L·∫§Y TH√îNG TIN T·ª™ ACTION CODE
        const info = await checkActionCode(auth, oobCode);
        const email = info.data.email;
        
        console.log("Email c·∫ßn x√°c th·ª±c:", email);
        
        // üî• T√åM USER TRONG FIRESTORE B·∫∞NG EMAIL
        const user = await findUserByEmail(email);
        
        if (!user) {
          throw new Error("Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n v·ªõi email: " + email);
        }
        
        console.log("T√¨m th·∫•y user:", user.id);
        
        // üî• X√ÅC TH·ª∞C EMAIL TRONG FIREBASE AUTH
        await applyActionCode(auth, oobCode);
        
        // üî• C·∫¨P NH·∫¨T FIRESTORE - QUAN TR·ªåNG!
        await updateUserStatusInFirestore(user.id, 'active');
        
        statusDiv.innerHTML = `
          <div class="message success">
            <h3>üéâ X√°c th·ª±c th√†nh c√¥ng!</h3>
            <p>T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t th√†nh c√¥ng.</p>
            <p>Email: <strong>${email}</strong></p>
            <p>B√¢y gi·ªù b·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√† b·∫Øt ƒë·∫ßu mua s·∫Øm.</p>
          </div>
        `;
        
        stepsContainer.style.display = 'none';
        resendBtn.style.display = 'none';
        
        // T·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng sau 5 gi√¢y
        setTimeout(() => {
          window.location.href = "login.html";
        }, 5000);

      } catch (error) {
        console.error("L·ªói x√°c th·ª±c email:", error);
        statusDiv.innerHTML = `
          <div class="message error">
            <h3>‚ùå X√°c th·ª±c th·∫•t b·∫°i</h3>
            <p>${error.message}</p>
            <p>Vui l√≤ng y√™u c·∫ßu g·ª≠i l·∫°i email x√°c th·ª±c.</p>
          </div>
        `;
        stepsContainer.style.display = 'block';
        resendBtn.style.display = 'block';
      }
    }

    // Ki·ªÉm tra tr·∫°ng th√°i user khi ƒë√£ ƒëƒÉng nh·∫≠p
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        if (user.emailVerified) {
          // üî• T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T FIRESTORE N·∫æU NG∆Ø·ªúI D√ôNG ƒê√É X√ÅC TH·ª∞C
          await updateUserStatusInFirestore(user.uid, 'active');
          
          statusDiv.innerHTML = `
            <div class="message success">
              <h3>‚úÖ Email ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c</h3>
              <p>Email <strong>${user.email}</strong> ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c th√†nh c√¥ng.</p>
              <p>T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ s·∫µn s√†ng ƒë·ªÉ s·ª≠ d·ª•ng.</p>
            </div>
          `;
          stepsContainer.style.display = 'none';
          resendBtn.style.display = 'none';
        } else {
          statusDiv.innerHTML = `
            <div class="message warning">
              <h3>üìß Email ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c</h3>
              <p>Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ c·ªßa <strong>${user.email}</strong></p>
              <p>Click v√†o li√™n k·∫øt x√°c th·ª±c trong email ƒë·ªÉ k√≠ch ho·∫°t t√†i kho·∫£n.</p>
              <p><small style="color: #64748b;">Ki·ªÉm tra c·∫£ th∆∞ m·ª•c spam n·∫øu kh√¥ng th·∫•y email.</small></p>
            </div>
          `;
          stepsContainer.style.display = 'block';
          resendBtn.style.display = 'block';
        }
      } else {
        statusDiv.innerHTML = `
          <div class="message">
            <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ x√°c th·ª±c email.</p>
            <p>N·∫øu b·∫°n v·ª´a click li√™n k·∫øt t·ª´ email, vui l√≤ng ch·ªù trong gi√¢y l√°t...</p>
          </div>
        `;
        resendBtn.style.display = 'none';
      }
    });

    // G·ª≠i l·∫°i email x√°c th·ª±c
    resendBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (user && !user.emailVerified) {
        try {
          resendBtn.disabled = true;
          resendBtn.innerHTML = '<span class="material-symbols-outlined">hourglass_empty</span> ƒêang g·ª≠i...';
          
          await sendEmailVerification(user);
          
          statusDiv.innerHTML += `
            <div class="message success" style="margin-top: 10px;">
              <p>‚úÖ ƒê√£ g·ª≠i l·∫°i email x√°c th·ª±c!</p>
              <p>Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ c·ªßa b·∫°n.</p>
            </div>
          `;
          
          // ƒê·∫øm ng∆∞·ª£c 60 gi√¢y tr∆∞·ªõc khi cho ph√©p g·ª≠i l·∫°i
          let countdown = 60;
          const countdownInterval = setInterval(() => {
            resendBtn.innerHTML = `<span class="material-symbols-outlined">timer</span> G·ª≠i l·∫°i sau ${countdown}s`;
            countdown--;
            
            if (countdown < 0) {
              clearInterval(countdownInterval);
              resendBtn.disabled = false;
              resendBtn.innerHTML = '<span class="material-symbols-outlined">send</span> G·ª≠i l·∫°i email x√°c th·ª±c';
            }
          }, 1000);
          
        } catch (error) {
          console.error("L·ªói g·ª≠i l·∫°i email x√°c th·ª±c:", error);
          statusDiv.innerHTML += `
            <div class="message error" style="margin-top: 10px;">
              <p>‚ùå L·ªói: ${error.message}</p>
            </div>
          `;
          resendBtn.disabled = false;
          resendBtn.innerHTML = '<span class="material-symbols-outlined">send</span> G·ª≠i l·∫°i email x√°c th·ª±c';
        }
      }
    });
  </script>
</body>
</html>