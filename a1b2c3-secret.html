<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªá th·ªëng Qu·∫£n tr·ªã - Store Phone</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"/>
  <link rel="stylesheet" href="assets/css/base.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-container {
      width: 100%;
      max-width: 420px;
    }
    
    .login-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.5s ease;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .logo {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .logo-icon {
      font-size: 4rem;
      color: #3b82f6;
      margin-bottom: 10px;
    }
    
    .logo h1 {
      font-size: 2.4rem;
      color: #1e293b;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .logo p {
      font-size: 1.4rem;
      color: #64748b;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-size: 1.4rem;
      color: #475569;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-input {
      width: 100%;
      padding: 16px 20px;
      font-size: 1.6rem;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      transition: all 0.3s ease;
      background: #f8fafc;
      color: #1e293b;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      background: white;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
    
    .form-input::placeholder {
      color: #94a3b8;
    }
    
    .login-btn {
      width: 100%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      padding: 18px;
      border-radius: 12px;
      font-size: 1.6rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
    }
    
    .login-btn:active {
      transform: translateY(0);
    }
    
    .login-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .message {
      text-align: center;
      font-size: 1.4rem;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .message.show {
      opacity: 1;
    }
    
    .message.error {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }
    
    .message.success {
      background: #d1fae5;
      color: #059669;
      border: 1px solid #a7f3d0;
    }
    
    .security-notice {
      text-align: center;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
    }
    
    .security-icon {
      font-size: 2rem;
      color: #64748b;
      margin-bottom: 10px;
    }
    
    .security-text {
      font-size: 1.2rem;
      color: #94a3b8;
      line-height: 1.5;
    }
    
    .footer-links {
      text-align: center;
      margin-top: 20px;
    }
    
    .back-home {
      color: #64748b;
      text-decoration: none;
      font-size: 1.3rem;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: color 0.3s ease;
    }
    
    .back-home:hover {
      color: #3b82f6;
    }
    
    @media (max-width: 480px) {
      .login-box {
        padding: 30px 25px;
      }
      
      .logo h1 {
        font-size: 2rem;
      }
    }
    
    /* Hi·ªáu ·ª©ng loading */
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .login-btn.loading .spinner {
      display: block;
    }
    
    .login-btn.loading span {
      display: none;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-box">
      <div class="logo">
        <div class="material-symbols-outlined logo-icon">admin_panel_settings</div>
        <h1>H·ªá Th·ªëng Qu·∫£n Tr·ªã</h1>
        <p>Store Phone Management</p>
      </div>
      
      <form id="loginForm">
        <div class="form-group">
          <label for="email" class="form-label">
            <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 5px;">mail</span>
            Email
          </label>
          <input 
            type="email" 
            id="email" 
            class="form-input" 
            placeholder="Nh·∫≠p email c·ªßa b·∫°n"
            required
            autocomplete="username"
            autofocus
          >
        </div>
        
        <div class="form-group">
          <label for="password" class="form-label">
            <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 5px;">lock</span>
            M·∫≠t kh·∫©u
          </label>
          <input 
            type="password" 
            id="password" 
            class="form-input" 
            placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
            required
            autocomplete="current-password"
          >
        </div>
        
        <button type="submit" class="login-btn" id="loginBtn">
          <div class="spinner"></div>
          <span>ƒêƒÉng nh·∫≠p</span>
        </button>
        
        <div id="message" class="message"></div>
      </form>
      
      <div class="security-notice">
        <div class="material-symbols-outlined security-icon">security</div>
        <p class="security-text">
          Ch·ªâ d√†nh cho nh√¢n vi√™n v√† qu·∫£n tr·ªã vi√™n ƒë∆∞·ª£c ·ªßy quy·ªÅn.<br>
          M·ªçi h√†nh vi truy c·∫≠p tr√°i ph√©p s·∫Ω b·ªã x·ª≠ l√Ω.
        </p>
      </div>
      
      <div class="footer-links">
        <a href="../index.html" class="back-home">
          <span class="material-symbols-outlined">arrow_back</span>
          Quay l·∫°i trang ch·ªß
        </a>
      </div>
    </div>
  </div>

<script type="module">
  import { firebaseConfig } from './assets/js/API.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        signOut,
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        getDocs, 
        query, 
        where 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const message = document.getElementById('message');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');

    // H√†m hi·ªÉn th·ªã th√¥ng b√°o
    function showMessage(text, type = 'error') {
        message.textContent = text;
        message.className = `message ${type} show`;
        console.log(`[MSG] ${type}: ${text}`);
    }

    // H√†m hi·ªÉn th·ªã loading
    function setLoading(isLoading) {
        if (isLoading) {
            loginBtn.disabled = true;
            loginBtn.classList.add('loading');
        } else {
            loginBtn.disabled = false;
            loginBtn.classList.remove('loading');
        }
    }

    // X√ìA AUTO-LOGOUT TRONG onAuthStateChanged
    onAuthStateChanged(auth, async (user) => {
        console.log("üîê Auth state changed - User:", user ? user.email : "Not logged in");
        
        // CH·ªà x·ª≠ l√Ω auto-login khi c√≥ remember me
        const rememberMe = localStorage.getItem('adminRememberMe');
        
        if (user && rememberMe === 'true') {
            console.log("üîÑ ƒê√£ ƒëƒÉng nh·∫≠p + remember me, ki·ªÉm tra admin...");
            try {
                // Ki·ªÉm tra admin
                const adminsRef = collection(db, "admins");
                const q = query(adminsRef, where("email", "==", user.email));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    console.log("‚úÖ Auto-login th√†nh c√¥ng!");
                    showMessage('ƒêang kh√¥i ph·ª•c phi√™n l√†m vi·ªác...', 'success');
                    setTimeout(() => {
                        window.location.href = "admin/index.html";
                    }, 1000);
                } else {
                    console.log("‚ùå Kh√¥ng ph·∫£i admin, ƒëƒÉng xu·∫•t...");
                    await signOut(auth);
                    localStorage.removeItem('adminRememberMe');
                }
            } catch (error) {
                console.error("Check admin error:", error);
            }
        }
        // KH√îNG t·ª± ƒë·ªông logout khi kh√¥ng c√≥ remember me
    });

    // X·ª≠ l√Ω submit form - ƒê∆†N GI·∫¢N H√ìA
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const rememberMe = document.getElementById('rememberMe')?.checked || false;

        console.log("üîÑ ƒêang x·ª≠ l√Ω login...");
        console.log("Email:", email);
        console.log("Remember me:", rememberMe);

        // Validate
        if (!email || !password) {
            showMessage('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
            return;
        }

        if (!email.includes('@')) {
            showMessage('Email kh√¥ng h·ª£p l·ªá!');
            return;
        }

        try {
            // Hi·ªÉn th·ªã loading
            setLoading(true);
            showMessage('ƒêang x√°c th·ª±c...');

            // 1. ƒêƒÉng nh·∫≠p Firebase Auth
            console.log("1. ƒêang ƒëƒÉng nh·∫≠p Firebase Auth...");
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            console.log("‚úÖ Firebase Auth th√†nh c√¥ng:", user.email);
            showMessage('X√°c th·ª±c th√†nh c√¥ng! ƒêang ki·ªÉm tra quy·ªÅn...', 'success');

            // L∆∞u remember me
            if (rememberMe) {
                localStorage.setItem('adminRememberMe', 'true');
                console.log("üíæ ƒê√£ l∆∞u remember me");
            } else {
                localStorage.removeItem('adminRememberMe');
                console.log("üóëÔ∏è Kh√¥ng l∆∞u remember me");
            }

            // 2. Ki·ªÉm tra trong collection "admins"
            console.log("2. ƒêang ki·ªÉm tra quy·ªÅn admin trong Firestore...");
            const adminsRef = collection(db, "admins");
            const q = query(adminsRef, where("email", "==", email));
            
            console.log("üîç Query:", {
                collection: "admins",
                where: ["email", "==", email]
            });
            
            const snapshot = await getDocs(q);
            console.log("‚úÖ Query th√†nh c√¥ng! S·ªë documents:", snapshot.docs.length);
            
            if (snapshot.empty) {
                console.log("‚ùå Kh√¥ng t√¨m th·∫•y trong admins collection");
                console.log("üëâ C·∫ßn ki·ªÉm tra Firestore c√≥ document v·ªõi email n√†y kh√¥ng?");
                
                await signOut(auth);
                localStorage.removeItem('adminRememberMe');
                showMessage('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p h·ªá th·ªëng qu·∫£n tr·ªã!');
                setLoading(false);
                return;
            }

            // L·∫•y th√¥ng tin admin
            const adminData = snapshot.docs[0].data();
            console.log("‚úÖ Admin data:", adminData);
            console.log("Admin name:", adminData.name);
            console.log("Admin role:", adminData.role);

            // L∆∞u th√¥ng tin
            sessionStorage.setItem('adminEmail', email);
            sessionStorage.setItem('adminName', adminData.name || 'Admin');
            sessionStorage.setItem('adminRole', adminData.role || 'admin');

            // X√≥a form
            emailInput.value = '';
            passwordInput.value = '';
            if (document.getElementById('rememberMe')) {
                document.getElementById('rememberMe').checked = false;
            }

            // Th√†nh c√¥ng
            console.log("üéâ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...");
            showMessage(`Xin ch√†o ${adminData.name || 'Qu·∫£n tr·ªã vi√™n'}!`, 'success');
            
            setTimeout(() => {
                window.location.href = "admin/index.html";
            }, 1500);

        } catch (err) {
            console.error("‚ùå Login error chi ti·∫øt:", err);
            console.error("Error code:", err.code);
            console.error("Error message:", err.message);
            
            setLoading(false);
            localStorage.removeItem('adminRememberMe');
            
            // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
            let errorMsg = 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i! ';
            
            switch (err.code) {
                case 'auth/wrong-password':
                    errorMsg = 'M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!';
                    break;
                case 'auth/user-not-found':
                    errorMsg = 'T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i!';
                    break;
                case 'auth/invalid-email':
                    errorMsg = 'Email kh√¥ng h·ª£p l·ªá!';
                    break;
                case 'auth/too-many-requests':
                    errorMsg = 'Qu√° nhi·ªÅu l·∫ßn th·ª≠. Vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t!';
                    break;
                case 'auth/network-request-failed':
                    errorMsg = 'L·ªói k·∫øt n·ªëi m·∫°ng!';
                    break;
                case 'permission-denied':
                    errorMsg = 'L·ªói quy·ªÅn truy c·∫≠p Firestore! Vui l√≤ng ki·ªÉm tra Firebase Rules.';
                    console.log("üîß H∆∞·ªõng d·∫´n s·ª≠a Rules:");
                    console.log("1. V√†o Firebase Console ‚Üí Firestore ‚Üí Rules");
                    console.log("2. D√°n rules sau:");
                    console.log(`
                      rules_version = '2';
                      service cloud.firestore {
                        match /databases/{database}/documents {
                          // CHO PH√âP T·∫§T C·∫¢ ƒê·ªÇ TEST
                          match /{document=**} {
                            allow read, write: if true;
                          }
                        }
                      }
                    `);
                    console.log("3. Nh·∫•n PUBLISH");
                    break;
                default:
                    errorMsg = 'L·ªói h·ªá th·ªëng: ' + (err.message || 'Kh√¥ng x√°c ƒë·ªãnh');
            }
            
            showMessage(errorMsg);
            passwordInput.value = '';
            passwordInput.focus();
        }
    });

    // Enter key support
    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            loginForm.requestSubmit();
        }
    });

    // Auto-focus
    emailInput.focus();

    // Debug: Test Firestore access
    window.testFirestore = async () => {
        console.log("üß™ Testing Firestore access...");
        try {
            const testRef = collection(db, "admins");
            const q = query(testRef, where("email", "==", "admin@storephone.com"));
            const snapshot = await getDocs(q);
            console.log("‚úÖ Test th√†nh c√¥ng! Documents:", snapshot.docs.length);
            snapshot.forEach(doc => {
                console.log("Document:", doc.data());
            });
        } catch (error) {
            console.error("‚ùå Test th·∫•t b·∫°i:", error);
        }
    };

    // Log b·∫£o m·∫≠t
    console.log('%c‚ö†Ô∏è H·ªÜ TH·ªêNG QU·∫¢N TR·ªä ‚ö†Ô∏è', 'color: red; font-size: 16px; font-weight: bold;');
    
</script>
</body>
</html>