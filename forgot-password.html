<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuÃªn máº­t kháº©u - Store Phone</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"/>
  <link rel="stylesheet" href="./assets/css/login-register.css">
</head>
<body>
  <div class="auth-container">
    <div class="auth-box">
      <div class="logo">
        <div class="material-symbols-outlined logo-icon">key</div>
        <h1>QuÃªn máº­t kháº©u</h1>
        <p>Nháº­p email Ä‘á»ƒ Ä‘áº·t láº¡i máº­t kháº©u</p>
      </div>
      
      <form id="resetForm">
        <div class="form-group">
          <label for="email" class="form-label">
            <span class="material-symbols-outlined">mail</span>
            Email
          </label>
          <input 
            type="email" 
            id="email" 
            class="form-input" 
            placeholder="Nháº­p email cá»§a báº¡n"
            required
            autocomplete="username"
            autofocus
          >
        </div>
        
        <div class="email-notice" style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 1.3rem; color: #92400e;">
          <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.8rem;">info</span>
          ChÃºng tÃ´i sáº½ gá»­i liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u Ä‘áº¿n email cá»§a báº¡n.
        </div>
        
        <button type="submit" class="auth-btn" id="resetBtn">
          <div class="spinner"></div>
          <span>Gá»­i liÃªn káº¿t Ä‘áº·t láº¡i</span>
        </button>
        
        <div id="message" class="message"></div>
      </form>
      
      <div class="auth-footer">
        <a href="login.html" class="auth-links">
          <span class="material-symbols-outlined">arrow_back</span>
          Quay láº¡i Ä‘Äƒng nháº­p
        </a>
        <div style="margin-top: 10px;">
          <a href="index.html" class="auth-links">
            <span class="material-symbols-outlined">home</span>
            Vá» trang chá»§
          </a>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, 
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0ua4VVMCYnJa2ndQ2MMgDYPNdCEfoxwY",
      authDomain: "products-a39df.firebaseapp.com",
      projectId: "products-a39df",
      storageBucket: "products-a39df.firebasestorage.app",
      messagingSenderId: "708345988066",
      appId: "1:708345988066:web:b8011a4859285450162fbb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const resetForm = document.getElementById('resetForm');
    const resetBtn = document.getElementById('resetBtn');
    const message = document.getElementById('message');

    // HÃ m hiá»ƒn thá»‹ thÃ´ng bÃ¡o
    function showMessage(text, type = 'error') {
      message.innerHTML = text;
      message.className = `message ${type} show`;
    }

    // HÃ m hiá»ƒn thá»‹ loading
    function setLoading(isLoading) {
      if (isLoading) {
        resetBtn.disabled = true;
        resetBtn.classList.add('loading');
      } else {
        resetBtn.disabled = false;
        resetBtn.classList.remove('loading');
      }
    }

    // ğŸ”¥ HÃ€M KIá»‚M TRA TÃ€I KHOáº¢N TRONG FIRESTORE
    async function checkUserExistsInFirestore(email) {
      try {
        console.log("ğŸ” Äang kiá»ƒm tra email trong Firestore:", email);
        
        // Kiá»ƒm tra trong collection "users" trÆ°á»›c
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("email", "==", email.toLowerCase()));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          console.log("âœ… TÃ¬m tháº¥y user trong Firestore (users collection)");
          const userDoc = querySnapshot.docs[0];
          const userData = userDoc.data();
          
          return {
            exists: true,
            status: userData.status || 'active',
            userId: userDoc.id,
            name: userData.name || '',
            source: 'users'
          };
        }
        
        // Kiá»ƒm tra trong collection "admins" náº¿u khÃ´ng tÃ¬m tháº¥y trong users
        const adminsRef = collection(db, "admins");
        const adminQ = query(adminsRef, where("email", "==", email.toLowerCase()));
        const adminSnapshot = await getDocs(adminQ);
        
        if (!adminSnapshot.empty) {
          console.log("âœ… TÃ¬m tháº¥y admin trong Firestore (admins collection)");
          const adminDoc = adminSnapshot.docs[0];
          const adminData = adminDoc.data();
          
          return {
            exists: true,
            status: adminData.status || 'active',
            userId: adminDoc.id,
            name: adminData.name || '',
            source: 'admins'
          };
        }
        
        console.log("âŒ KhÃ´ng tÃ¬m tháº¥y email trong cáº£ users vÃ  admins collections");
        return { exists: false, status: 'active' };
      } catch (error) {
        console.error("âŒ Lá»—i khi kiá»ƒm tra user trong Firestore:", error);
        return { exists: false, status: 'active' };
      }
    }

    // Xá»­ lÃ½ submit form
    resetForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value.trim();

      // Reset message
      message.className = 'message';
      message.textContent = '';

      if (!email || !email.includes('@')) {
        showMessage('Vui lÃ²ng nháº­p email há»£p lá»‡!');
        return;
      }

      try {
        setLoading(true);
        showMessage('Äang kiá»ƒm tra tÃ i khoáº£n...', 'info');

        // ğŸ”¥ KIá»‚M TRA TÃ€I KHOáº¢N TRONG FIRESTORE TRÆ¯á»šC
        console.log("ğŸ”„ Báº¯t Ä‘áº§u kiá»ƒm tra tÃ i khoáº£n cho email:", email);
        const userStatus = await checkUserExistsInFirestore(email);
        
        if (!userStatus.exists) {
          showMessage('KhÃ´ng tÃ¬m tháº¥y tÃ i khoáº£n vá»›i email nÃ y!', 'error');
          setLoading(false);
          return;
        }

        // Kiá»ƒm tra tráº¡ng thÃ¡i tÃ i khoáº£n
        if (userStatus.status === 'banned' || userStatus.status === 'inactive') {
          showMessage('TÃ i khoáº£n nÃ y Ä‘Ã£ bá»‹ khÃ³a. Vui lÃ²ng liÃªn há»‡ quáº£n trá»‹ viÃªn!', 'error');
          setLoading(false);
          return;
        }

        console.log("âœ… TÃ i khoáº£n há»£p lá»‡, Ä‘ang gá»­i email Ä‘áº·t láº¡i máº­t kháº©u...");
        showMessage('Äang gá»­i liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u...', 'info');

        // ğŸ”¥ Gá»¬I EMAIL Äáº¶T Láº I Máº¬T KHáº¨U TRá»°C TIáº¾P
        await sendPasswordResetEmail(auth, email);
        
        console.log("âœ… Email Ä‘áº·t láº¡i máº­t kháº©u Ä‘Ã£ Ä‘Æ°á»£c gá»­i");
        
        showMessage(`
          <div style="text-align: left;">
            <h4 style="color: #059669; margin-bottom: 10px;">âœ… ÄÃ£ gá»­i liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u!</h4>
            <p>ChÃºng tÃ´i Ä‘Ã£ gá»­i email Ä‘áº·t láº¡i máº­t kháº©u Ä‘áº¿n:</p>
            <p style="background: #f0f9ff; padding: 10px; border-radius: 6px; font-weight: 500;">${email}</p>
            <p style="margin-top: 10px; font-size: 1.3rem; color: #64748b;">
              <strong>Vui lÃ²ng lÃ m theo cÃ¡c bÆ°á»›c:</strong><br>
              1. Kiá»ƒm tra há»™p thÆ° cá»§a báº¡n<br>
              2. Click vÃ o liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u<br>
              3. Táº¡o máº­t kháº©u má»›i<br>
              4. ÄÄƒng nháº­p vá»›i máº­t kháº©u má»›i
            </p>
            <p style="margin-top: 10px; font-size: 1.2rem; color: #94a3b8;">
              ğŸ’¡ <strong>LÆ°u Ã½:</strong> Kiá»ƒm tra cáº£ thÆ° má»¥c <strong>Spam/Junk</strong> náº¿u khÃ´ng tháº¥y email.
            </p>
          </div>
        `, 'success');
        
        // XÃ³a form sau 5 giÃ¢y
        setTimeout(() => {
          document.getElementById('email').value = '';
        }, 5000);

      } catch (err) {
        console.error("âŒ Lá»—i gá»­i email:", err);
        setLoading(false);
        
        let errorMsg = 'KhÃ´ng thá»ƒ gá»­i liÃªn káº¿t Ä‘áº·t láº¡i máº­t kháº©u!';
        
        switch (err.code) {
          case 'auth/invalid-email':
            errorMsg = 'Email khÃ´ng há»£p lá»‡!';
            break;
          case 'auth/too-many-requests':
            errorMsg = 'QuÃ¡ nhiá»u yÃªu cáº§u. Vui lÃ²ng thá»­ láº¡i sau 15 phÃºt!';
            break;
          case 'auth/user-not-found':
            // Náº¿u Firebase Auth khÃ´ng tÃ¬m tháº¥y nhÆ°ng Firestore cÃ³, cÃ³ thá»ƒ user chÆ°a Ä‘Æ°á»£c táº¡o trong Auth
            errorMsg = 'TÃ i khoáº£n tá»“n táº¡i nhÆ°ng chÆ°a Ä‘Æ°á»£c kÃ­ch hoáº¡t trong há»‡ thá»‘ng xÃ¡c thá»±c. Vui lÃ²ng liÃªn há»‡ quáº£n trá»‹ viÃªn!';
            break;
          case 'auth/user-disabled':
            errorMsg = 'TÃ i khoáº£n nÃ y Ä‘Ã£ bá»‹ vÃ´ hiá»‡u hÃ³a. Vui lÃ²ng liÃªn há»‡ quáº£n trá»‹ viÃªn!';
            break;
          default:
            errorMsg = `Lá»—i: ${err.message || err.code}`;
        }
        
        showMessage(errorMsg, 'error');
        
        // Hiá»ƒn thá»‹ thÃªm thÃ´ng tin debug trong console
        console.log("ğŸ“‹ Chi tiáº¿t lá»—i:", {
          code: err.code,
          message: err.message,
          email: email
        });
      }
    });

    // Enter key support
    document.getElementById('email').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        resetForm.requestSubmit();
      }
    });

    // ThÃªm hÃ m test Ä‘á»ƒ debug
    window.testEmailCheck = async function() {
      const email = prompt("Nháº­p email Ä‘á»ƒ test:");
      if (!email) return;
      
      console.log("ğŸ§ª Test kiá»ƒm tra email:", email);
      const result = await checkUserExistsInFirestore(email);
      console.log("ğŸ“Š Káº¿t quáº£:", result);
      
      if (result.exists) {
        alert(`âœ… TÃ¬m tháº¥y tÃ i khoáº£n!\nTÃªn: ${result.name}\nCollection: ${result.source}\nTráº¡ng thÃ¡i: ${result.status}`);
      } else {
        alert("âŒ KhÃ´ng tÃ¬m tháº¥y tÃ i khoáº£n!");
      }
    };
  </script>
</body>
</html>