<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒêƒÉng k√Ω - Store Phone</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"/>
  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="./assets/css/login-register.css">
  <!-- üî• TH√äM reCAPTCHA SCRIPT -->
  <script src="https://www.google.com/recaptcha/api.js?render=6LeAvkcsAAAAAF6nLftuY36VaEqwnl_RB-qRBglH"></script>
  <style>
    /* Th√™m style cho tr·∫°ng th√°i s·ªë ƒëi·ªán tho·∫°i */
    .phone-status {
      font-size: 1.2rem;
      margin-top: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .phone-status.available {
      color: #10b981;
    }
    
    .phone-status.taken {
      color: #ef4444;
    }
    
    .phone-status.loading {
      color: #64748b;
    }
    
    .phone-status .material-symbols-outlined {
      font-size: 1.6rem;
    }
    
    .form-input.invalid {
      border-color: #ef4444;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
    }
    
    .form-input.valid {
      border-color: #10b981;
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-box">
      <div class="logo">
        <div class="material-symbols-outlined logo-icon">person_add</div>
        <h1>T·∫°o t√†i kho·∫£n m·ªõi</h1>
        <p>ƒêƒÉng k√Ω ƒë·ªÉ mua s·∫Øm d·ªÖ d√†ng h∆°n</p>
      </div>
      
      <form id="registerForm">
        <div class="form-group">
          <label for="name" class="form-label">
            <span class="material-symbols-outlined">person</span>
            H·ªç v√† t√™n
          </label>
          <input 
            type="text" 
            id="name" 
            class="form-input" 
            placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n"
            autocomplete="name"
          >
        </div>
        
        <div class="form-group">
          <label for="phone" class="form-label">
            <span class="material-symbols-outlined">phone</span>
            S·ªë ƒëi·ªán tho·∫°i
          </label>
          <input 
            type="tel" 
            id="phone" 
            class="form-input" 
            placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
            autocomplete="tel"
            pattern="[0-9]{10,11}"
            maxlength="11"
          >
          <!-- Th√™m th·∫ª hi·ªÉn th·ªã tr·∫°ng th√°i s·ªë ƒëi·ªán tho·∫°i -->
          <div id="phone-status" class="phone-status" style="display: none;">
            <span class="material-symbols-outlined">info</span>
            <span id="phone-status-text"></span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="email" class="form-label">
            <span class="material-symbols-outlined">mail</span>
            Email *
          </label>
          <input 
            type="email" 
            id="email" 
            class="form-input" 
            placeholder="Nh·∫≠p email c·ªßa b·∫°n"
            required
            autocomplete="username"
          >
        </div>
        
        <div class="form-group">
          <label for="password" class="form-label">
            <span class="material-symbols-outlined">lock</span>
            M·∫≠t kh·∫©u *
          </label>
          <div class="password-container">
            <input 
              type="password" 
              id="password" 
              class="form-input" 
              placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±"
              required
              autocomplete="new-password"
              minlength="6"
            >
            <button type="button" class="toggle-password" id="togglePassword">
              <span class="material-symbols-outlined">visibility</span>
            </button>
          </div>
          <div class="password-hint" style="font-size: 1.2rem; color: #64748b; margin-top: 5px;">
            <span id="passwordStrength"></span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="confirmPassword" class="form-label">
            <span class="material-symbols-outlined">lock_reset</span>
            X√°c nh·∫≠n m·∫≠t kh·∫©u *
          </label>
          <div class="password-container">
            <input 
              type="password" 
              id="confirmPassword" 
              class="form-input" 
              placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
              required
              autocomplete="new-password"
            >
            <button type="button" class="toggle-password" id="toggleConfirmPassword">
              <span class="material-symbols-outlined">visibility</span>
            </button>
          </div>
        </div>
        
        <!-- üî• reCAPTCHA Notice -->
        <div class="recaptcha-notice" style="font-size: 1.2rem; color: #64748b; margin: 10px 0; text-align: center;">
          <small>
            Trang n√†y ƒë∆∞·ª£c b·∫£o v·ªá b·ªüi reCAPTCHA v√† √°p d·ª•ng
            <a href="https://policies.google.com/privacy" target="_blank" style="color: #3b82f6;">Ch√≠nh s√°ch quy·ªÅn ri√™ng t∆∞</a> v√†
            <a href="https://policies.google.com/terms" target="_blank" style="color: #3b82f6;">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</a> c·ªßa Google.
          </small>
        </div>
        
        <div class="terms-checkbox">
          <input type="checkbox" id="agreeTerms" required>
          <label for="agreeTerms">
            T√¥i ƒë·ªìng √Ω v·ªõi <a href="#">ƒëi·ªÅu kho·∫£n d·ªãch v·ª•</a>
          </label>
        </div>
        
        <div class="email-notice" style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 1.3rem; color: #0369a1;">
          <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.8rem;">info</span>
          Sau khi ƒëƒÉng k√Ω, vui l√≤ng ki·ªÉm tra email ƒë·ªÉ x√°c th·ª±c t√†i kho·∫£n. B·∫°n ph·∫£i x√°c th·ª±c email tr∆∞·ªõc khi ƒëƒÉng nh·∫≠p.
        </div>
        
        <button type="submit" class="auth-btn" id="registerBtn">
          <div class="spinner"></div>
          <span>ƒêƒÉng k√Ω t√†i kho·∫£n</span>
        </button>
        
        <div id="message" class="message"></div>
      </form>
      
      <div class="auth-footer">
        <p style="color: #64748b; font-size: 1.4rem; margin-bottom: 15px;">
          ƒê√£ c√≥ t√†i kho·∫£n?
        </p>
        <a href="login.html" class="auth-links">
          <span class="material-symbols-outlined">login</span>
          ƒêƒÉng nh·∫≠p ngay
        </a>
        <div style="margin-top: 20px;">
          <a href="index.html" class="auth-links">
            <span class="material-symbols-outlined">arrow_back</span>
            Quay l·∫°i trang ch·ªß
          </a>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { firebaseConfig } from './assets/js/API.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword,
      sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      setDoc,
      serverTimestamp,
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const registerForm = document.getElementById('registerForm');
    const registerBtn = document.getElementById('registerBtn');
    const message = document.getElementById('message');
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const passwordStrength = document.getElementById('passwordStrength');
    const phoneInput = document.getElementById('phone');
    const phoneStatus = document.getElementById('phone-status');
    const phoneStatusText = document.getElementById('phone-status-text');

    // üî• reCAPTCHA SITE KEY
    const RECAPTCHA_SITE_KEY = '6LeAvkcsAAAAAF6nLftuY36VaEqwnl_RB-qRBglH';

    // üî• H√ÄM L·∫§Y reCAPTCHA TOKEN
    async function getRecaptchaToken(action = 'register') {
      return new Promise((resolve) => {
        grecaptcha.ready(async () => {
          try {
            const token = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: action });
            console.log('reCAPTCHA token received for', action);
            resolve(token);
          } catch (error) {
            console.error('reCAPTCHA error:', error);
            resolve(null);
          }
        });
      });
    }

    // üî• H√ÄM KI·ªÇM TRA S·ªê ƒêI·ªÜN THO·∫†I ƒê√É T·ªíN T·∫†I CH∆ØA
    async function checkPhoneExists(phone) {
      if (!phone || phone.trim() === '') {
        return { exists: false, message: '' };
      }
      
      // Ki·ªÉm tra ƒë·ªãnh d·∫°ng s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam
      const phoneRegex = /^(0[3|5|7|8|9])[0-9]{8}$/;
      if (!phoneRegex.test(phone)) {
        return { exists: false, message: 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá' };
      }
      
      try {
        // Ki·ªÉm tra trong Firestore xem c√≥ s·ªë ƒëi·ªán tho·∫°i n√†o tr√πng kh√¥ng
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("phone", "==", phone));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          return { 
            exists: true, 
            message: 'S·ªë ƒëi·ªán tho·∫°i n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng' 
          };
        } else {
          return { 
            exists: false, 
            message: 'S·ªë ƒëi·ªán tho·∫°i c√≥ th·ªÉ s·ª≠ d·ª•ng' 
          };
        }
      } catch (error) {
        console.error("L·ªói khi ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i:", error);
        return { exists: false, message: 'Kh√¥ng th·ªÉ ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i' };
      }
    }

    // üî• X·ª¨ L√ù KI·ªÇM TRA S·ªê ƒêI·ªÜN THO·∫†I KHI NH·∫¨P
    let phoneCheckTimeout;
    phoneInput.addEventListener('input', function() {
      const phone = this.value.trim();
      
      // ·∫®n tr·∫°ng th√°i c≈©
      phoneStatus.style.display = 'none';
      phoneInput.classList.remove('invalid', 'valid');
      
      // X√≥a timeout c≈© n·∫øu c√≥
      if (phoneCheckTimeout) {
        clearTimeout(phoneCheckTimeout);
      }
      
      // N·∫øu s·ªë ƒëi·ªán tho·∫°i ƒë·ªß 10-11 s·ªë, ki·ªÉm tra sau 500ms
      if (phone.length >= 10) {
        phoneCheckTimeout = setTimeout(async () => {
          phoneStatus.style.display = 'flex';
          phoneStatus.className = 'phone-status loading';
          phoneStatusText.textContent = 'ƒêang ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i...';
          
          const result = await checkPhoneExists(phone);
          
          if (result.exists) {
            phoneStatus.className = 'phone-status taken';
            phoneStatusText.textContent = result.message;
            phoneInput.classList.add('invalid');
            phoneInput.classList.remove('valid');
          } else if (result.message === 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá') {
            phoneStatus.className = 'phone-status taken';
            phoneStatusText.textContent = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (VD: 0912345678)';
            phoneInput.classList.add('invalid');
            phoneInput.classList.remove('valid');
          } else {
            phoneStatus.className = 'phone-status available';
            phoneStatusText.textContent = result.message;
            phoneInput.classList.add('valid');
            phoneInput.classList.remove('invalid');
          }
        }, 500);
      } else if (phone.length > 0 && phone.length < 10) {
        phoneStatus.style.display = 'flex';
        phoneStatus.className = 'phone-status taken';
        phoneStatusText.textContent = 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10-11 s·ªë';
        phoneInput.classList.add('invalid');
      }
    });

    // Ki·ªÉm tra ƒë·ªô m·∫°nh m·∫≠t kh·∫©u
    passwordInput.addEventListener('input', function() {
      const password = this.value;
      let strength = 0;
      let text = '';
      let color = '#64748b';
      
      if (password.length >= 8) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;
      
      switch(strength) {
        case 0:
          text = password.length > 0 ? 'R·∫•t y·∫øu' : '';
          color = '#ef4444';
          break;
        case 1:
          text = 'Y·∫øu';
          color = '#f97316';
          break;
        case 2:
          text = 'Trung b√¨nh';
          color = '#eab308';
          break;
        case 3:
          text = 'M·∫°nh';
          color = '#84cc16';
          break;
        case 4:
          text = 'R·∫•t m·∫°nh';
          color = '#10b981';
          break;
      }
      
      passwordStrength.textContent = text;
      passwordStrength.style.color = color;
    });

    // Hi·ªÉn th·ªã/·∫©n m·∫≠t kh·∫©u
    function setupPasswordToggle(button, input) {
      button.onclick = () => {
        const icon = button.querySelector('.material-symbols-outlined');
        if (input.type === 'password') {
          input.type = 'text';
          icon.textContent = 'visibility_off';
        } else {
          input.type = 'password';
          icon.textContent = 'visibility';
        }
      };
    }

    setupPasswordToggle(togglePassword, passwordInput);
    setupPasswordToggle(toggleConfirmPassword, confirmPasswordInput);

    // H√†m hi·ªÉn th·ªã th√¥ng b√°o
    function showMessage(text, type = 'error') {
      message.innerHTML = text;
      message.className = `message ${type} show`;
    }

    // H√†m hi·ªÉn th·ªã loading
    function setLoading(isLoading) {
      if (isLoading) {
        registerBtn.disabled = true;
        registerBtn.classList.add('loading');
      } else {
        registerBtn.disabled = false;
        registerBtn.classList.remove('loading');
      }
    }

    // X·ª≠ l√Ω submit form v·ªõi reCAPTCHA
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      const agreeTerms = document.getElementById('agreeTerms').checked;

      // Reset message
      message.className = 'message';
      message.textContent = '';

      // Validate
      if (!email || !password || !confirmPassword) {
        showMessage('Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u!');
        return;
      }

      if (!email.includes('@')) {
        showMessage('Email kh√¥ng h·ª£p l·ªá!');
        return;
      }

      if (password.length < 6) {
        showMessage('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
        return;
      }

      if (password !== confirmPassword) {
        showMessage('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
        return;
      }

      // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i
      if (phone) {
        const phoneRegex = /^(0[3|5|7|8|9])[0-9]{8}$/;
        if (!phoneRegex.test(phone)) {
          showMessage('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá! (VD: 0912345678)');
          phoneInput.focus();
          phoneInput.select();
          return;
        }
        
        // Ki·ªÉm tra xem s·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i ch∆∞a
        const phoneCheck = await checkPhoneExists(phone);
        if (phoneCheck.exists) {
          showMessage('S·ªë ƒëi·ªán tho·∫°i n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng. Vui l√≤ng s·ª≠ d·ª•ng s·ªë ƒëi·ªán tho·∫°i kh√°c!');
          phoneInput.focus();
          phoneInput.select();
          return;
        }
      }

      if (!agreeTerms) {
        showMessage('Vui l√≤ng ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n d·ªãch v·ª•!');
        return;
      }

      try {
        // Hi·ªÉn th·ªã loading
        setLoading(true);
        showMessage('ƒêang x√°c th·ª±c...');

        // üî• L·∫§Y reCAPTCHA TOKEN
        const recaptchaToken = await getRecaptchaToken('register');
        
        if (!recaptchaToken) {
          showMessage('Kh√¥ng th·ªÉ x√°c th·ª±c b·∫£o m·∫≠t. Vui l√≤ng t·∫£i l·∫°i trang!');
          setLoading(false);
          return;
        }

        showMessage('ƒêang t·∫°o t√†i kho·∫£n...');

        // T·∫°o user trong Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // üî• G·ª¨I EMAIL X√ÅC TH·ª∞C
        await sendEmailVerification(user);

        // L∆∞u th√¥ng tin v√†o Firestore v·ªõi status l√† 'pending' (ch·ªù x√°c th·ª±c)
        const userData = {
          uid: user.uid,
          name: name || email.split('@')[0],
          email: email,
          phone: phone || '',
          emailVerified: false,
          userType: 'customer',
          status: 'pending', // QUAN TR·ªåNG: Tr·∫°ng th√°i pending cho ƒë·∫øn khi x√°c th·ª±c email
          createdAt: serverTimestamp(),
          lastLogin: null,
          totalOrders: 0,
          totalSpent: 0
        };

        await setDoc(doc(db, "users", user.uid), userData);

        // TH√ÄNH C√îNG
        showMessage(`
          <div style="text-align: left;">
            <div style="color: #059669; font-weight: bold; font-size: 1.6rem; margin-bottom: 10px;">
              <span class="material-symbols-outlined" style="vertical-align: middle;">check_circle</span>
              ƒêƒÉng k√Ω th√†nh c√¥ng!
            </div>
            
            <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
              <strong>üìß Email x√°c th·ª±c ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn:</strong><br>
              <span style="color: #0369a1; font-weight: 500;">${email}</span>
            </div>
            
            <div style="font-size: 1.3rem; color: #475569; line-height: 1.5;">
              <strong>‚ö†Ô∏è VUI L√íNG L√ÄM THEO C√ÅC B∆Ø·ªöC SAU:</strong><br><br>
              1. <strong>Ki·ªÉm tra h·ªôp th∆∞</strong> c·ªßa b·∫°n<br>
              2. T√¨m email t·ª´ <strong>Store Phone</strong><br>
              3. <strong>Click v√†o li√™n k·∫øt x√°c th·ª±c</strong> trong email<br>
              4. Sau khi x√°c th·ª±c, t√†i kho·∫£n s·∫Ω ƒë∆∞·ª£c k√≠ch ho·∫°t<br>
              5. <strong>Quay l·∫°i ƒëƒÉng nh·∫≠p</strong> sau khi x√°c th·ª±c<br><br>
              
              <div style="background: #fef3c7; padding: 10px; border-radius: 6px; border: 1px solid #fbbf24;">
                <strong>üí° L∆∞u √Ω quan tr·ªçng:</strong><br>
                - B·∫°n <strong>ph·∫£i x√°c th·ª±c email</strong> tr∆∞·ªõc khi ƒëƒÉng nh·∫≠p<br>
                - Ki·ªÉm tra c·∫£ th∆∞ m·ª•c <strong>Spam/Junk</strong> n·∫øu kh√¥ng th·∫•y email<br>
                - Li√™n k·∫øt x√°c th·ª±c c√≥ hi·ªáu l·ª±c trong 24 gi·ªù
              </div>
            </div>
          </div>
        `, 'success');
        
        // Reset form
        registerForm.reset();
        passwordStrength.textContent = '';
        phoneStatus.style.display = 'none';
        phoneInput.classList.remove('invalid', 'valid');
        
        // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p sau 10 gi√¢y
        setTimeout(() => {
          window.location.href = "login.html";
        }, 10000);

      } catch (err) {
        console.error("L·ªói ƒëƒÉng k√Ω:", err);
        setLoading(false);
        
        let errorMsg = 'ƒêƒÉng k√Ω th·∫•t b·∫°i!';
        
        switch (err.code) {
          case 'auth/email-already-in-use':
            errorMsg = 'Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng! <a href="login.html" style="color: #3b82f6;">ƒêƒÉng nh·∫≠p ngay</a>';
            break;
          case 'auth/invalid-email':
            errorMsg = 'Email kh√¥ng h·ª£p l·ªá!';
            break;
          case 'auth/weak-password':
            errorMsg = 'M·∫≠t kh·∫©u qu√° y·∫øu! Vui l√≤ng ch·ªçn m·∫≠t kh·∫©u m·∫°nh h∆°n.';
            break;
          case 'auth/operation-not-allowed':
            errorMsg = 'Ch·ª©c nƒÉng ƒëƒÉng k√Ω t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng!';
            break;
          case 'auth/too-many-requests':
            errorMsg = 'Qu√° nhi·ªÅu y√™u c·∫ßu ƒëƒÉng k√Ω. Vui l√≤ng th·ª≠ l·∫°i sau 15 ph√∫t!';
            break;
        }
        
        showMessage(errorMsg);
        passwordInput.value = '';
        confirmPasswordInput.value = '';
        passwordStrength.textContent = '';
        passwordInput.focus();
      }
    });

    // Enter key support
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        registerForm.requestSubmit();
      }
    });

    // Auto-focus
    document.getElementById('name').focus();
  </script>
</body>
</html>